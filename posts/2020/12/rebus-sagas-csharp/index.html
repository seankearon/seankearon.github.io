<!doctype html>
<html lang="en">

  <head>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-PLZXKRS9R9"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-PLZXKRS9R9');
    </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="How to model and build long-running business processes using C# and Rebus and host them on Azure App Service.">
  <meta name="author" content="">

    <link rel="icon" type="image/x-icon" href="/img/favicon.png"/>

  <title>Long-running business processes in C# with Rebus on Azure</title>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" integrity="sha512-rt/SrQ4UNIaGfDyEXZtNcyWvQeOq0QLygHluFQcSjaGB04IxWhal71tKuzP6K8eYXYB6vJV4pHkXcmFGGQ1/0w==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Custom fonts for this template -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    <link href="https://unpkg.com/prismjs@1.20.0/themes/prism-okaidia.css" rel="stylesheet">

    <!-- Custom styles for this template -->
  <link href="/css/clean-blog.css" rel="stylesheet">


    <link rel="alternate" href="/feed/feed.xml" type="application/atom+xml" title="Atlantic Breeze">
    <link rel="alternate" href="/feed/feed.json" type="application/json" title="Atlantic Breeze">
  </head>
  <body>

 <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
    <div class="container">
      <a class="navbar-brand" href="/">Atlantic Breeze</a>
      <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
        Menu
        <i class="fas fa-bars"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarResponsive">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <a href="/">Home</a></li>
            <li class="nav-item">
              <a href="/posts/">Archive</a></li>
            <li class="nav-item">
              <a href="/about/">About Me</a></li>
          <li class="nav-item">
            <a href="https://kearon.blogspot.com" target="_blank">My Previous Blog</a></li>
        </ul>
      </div>
    </div>
  </nav>

      <main class="tmpl-post">

      <!-- Page Header -->
<header class="masthead" style="background-image: url(/img/chilli-stall.jpg)">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <div class="post-heading">
          <h1>Long-running business processes in C# with Rebus on Azure</h1>
          

          
          <span class="meta">
            Posted on <time class="postlist-date" datetime="2020-12-07">07 December 2020</time>
          </span>
          

        </div>
      </div>
    </div>
  </div>
</header>

<!-- Post Content -->
<article>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">

        <p>This post is part of the <a href="https://www.csadvent.christmas/">C# Advent Calendar 2020</a>.  There is an equivalent post in F# <a href="https://seankearon.me/posts/2020/11/rebus-sagas-fsharp/">here</a>.</p>
<p><strong>Note April 2024:</strong> The original code in this post is based on Rebus 6 and .Net 5.  The code in GitHub has now been updated to Rebus 8 and .Net 8.  Differences can be viewed in the <a href="https://github.com/seankearon/rebus-onboardingcs/pull/1">here</a>.</p>
<h1 id="introduction" tabindex="-1">Introduction <a class="direct-link" href="#introduction">#</a></h1>
<p>This post talks about how to build a system that runs a long-running business process (aka workflow or &quot;saga&quot;) using a .Net library called <a href="https://github.com/rebus-org/Rebus">Rebus</a>.</p>
<p>Rebus is a library that makes it easy to build reliable, distributed systems.  We will show how to host our Rebus system in Azure App Services.  You will also be able to run it by pressing F5 in your IDE.</p>
<p>We will be implementing a set of fictional, but quite typical business requirements around the onboarding of a new customer.</p>
<p>So, let's get started!</p>
<h1 id="introducing-rebus" tabindex="-1">Introducing Rebus <a class="direct-link" href="#introducing-rebus">#</a></h1>
<p>Rebus is a distributed, asynchronous and durable .Net Service Bus that is a pleasure to use.  I like to think of Rebus as microservices without the <a href="https://en.wiktionary.org/wiki/faff">faff</a>!  It's a .Net library uses messages to communicate between parts of your application and can do that reliably by using one of the various options for transporting and sharing those messages.  Rebus can be anywhere your application is (except on mobile and embedded devices afaik).</p>
<p>I've been using Rebus for a long time now.  In my current gig, we are using Rebus in a national medicines optimisation healthcare system that serves around 50 million patients across the UK.  Rebus has helped us simplify and centralise a lot of complex, legacy back end processing and allow us to move the system from on-prem to the cloud.</p>
<p>As a &quot;message-based architecture&quot;, Rebus is similar to other .Net Service Buses such as NServiceBus, Mass Transit or EasyNetQ.  Like these other service buses, Rebus uses a push model where it reacts to incoming messages.  This is distinct to streaming approaches such as used by Kafka, etc.</p>
<p>Rebus is open source (MIT), completely free to use and has around 1.4K GitHub stars.  It is Danish software and the founder and primary maintainer is Mogens Heller Grabe (<a href="https://twitter.com/mookid8000">@mookid8000</a>).  Mogens runs a company that provides consultancy, support and some rather excellent monitoring software for use with Rebus (more details here: <a href="https://rebus.fm/services/">https://rebus.fm/services/</a>).</p>
<p>Thanks to Mogens for kindly reviewing the content of this post.</p>
<h1 id="what-good-things-does-rebus-bring-us%3F" tabindex="-1">What good things does Rebus bring us? <a class="direct-link" href="#what-good-things-does-rebus-bring-us%3F">#</a></h1>
<p>Rebus brings high levels of reliability to your system.  Each message will either be processed or sent to an error queue so that you can fix the problem and replay it later.</p>
<p>Rebus naturally breaks your system down into small chunks of functionality called handlers that are easy to write, reason about and test.  I find working with Rebus to be a very good developer experience (and the error messages are really useful too!).</p>
<p>One or more handlers can respond to and process messages, which makes it very easy to extend your system without changing existing code.  Different handlers that process the same message do not need to be in the same application component.  This makes it easy to architect your application in a manner that supports your performance, scaling and security needs.</p>
<p>Rebus can use various technologies to store messages that are being processed.  These are called <a href="https://github.com/rebus-org/Rebus/wiki/Transport">message transports</a> and include RabbitMQ, Azure Service Bus, Amazon SQS and various databases.  There are also transports that use the file system or in-memory.  Rebus relies on the transport to provide durability and reliability, so you probably don't want to use the in-memory transport when you care about losing messages!  If Rebus can't process a message then it can retry that processing either in using a <a href="https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#customizing-retries">simple approach</a>, using a <a href="https://github.com/rebus-org/Rebus/wiki/Back-off-strategy">back-off strategy</a> and you can also add a <a href="https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#second-level-retries">second layer of processing</a> for a more comprehensive approach to handling failures.</p>
<p>Ultimately, if the message can't be processed for whatever reason, then Rebus will keep it for you in the part of the transport that you nominate as the error queue when you configure Rebus.  As well as the message, Rebus also stores the details of the failures in the message's headers so that you can easily see what went wrong and fix it.  When you've put the database server's plug back into the wall, or fixed the cause of the failure in some other way, you can move the message back to the processing queue so that processing can begin again!</p>
<p>There are plenty of other good things in Rebus that we don't have time to talk about here, such as</p>
<ul>
<li><a href="https://github.com/rebus-org/Rebus/wiki/Data-bus">Transporting larger data using the Data Bus</a>.</li>
<li><a href="https://github.com/rebus-org/Rebus/wiki/Workers-and-parallelism">Controlling the number of workers and parallelism</a>.</li>
<li><a href="https://github.com/rebus-org/Rebus/wiki/Wire-level-format-of-messages">Controlling how Rebus serialises messages</a>.</li>
<li><a href="https://github.com/rebus-org/Rebus/wiki/Message-compression-and-encryption">Compressing and encrypting the contents of messages</a></li>
</ul>
<p>As you'd expect, there is superb support for <a href="https://github.com/rebus-org/Rebus/wiki/Testing">testing too</a>!</p>
<p>Check out the official wiki here:</p>
<p><a href="https://github.com/rebus-org/Rebus/wiki">https://github.com/rebus-org/Rebus/wiki</a></p>
<h1 id="overview-of-our-scenario" tabindex="-1">Overview of our scenario <a class="direct-link" href="#overview-of-our-scenario">#</a></h1>
<p>We are going to jump into Rebus a little beyond the basics of request/reply or pub/sub and look at how to model long-running, durable workflows (aka sagas) in Rebus.  We are going to use Rebus to build an application that processes new customers for a hypothetical business and then host that in an Azure App Service.  You could also run the same code as a Windows Service if you want, and it will run just the same in your IDE when you press F5 (or whatever you press to run your shizzle!).</p>
<p>We're going to add a few requirements into our made-up business scenario, just so that we can showcase some of Rebus' features.  Let's take a look at the business requirements.</p>
<p>We're going to model a business process that is under an <a href="https://en.wikipedia.org/wiki/Operational-level_agreement">OLA</a> and which has compensating actions that must be taken if the requirements in the OLA are not met.</p>
<p>The business wants us to build a system to handle the onboarding of new customers.  As well as functional requirements, the business also have operational requirements so that they can meet their <a href="https://en.wikipedia.org/wiki/Operational-level_agreement">operational level agreements (OLA)</a>.  When a new customer is taken on, the business wants the following to happen:</p>
<ul>
<li>An account is to be created for the customer.</li>
<li>A welcome email is to be sent to the customer after the account is created.</li>
<li>A sales call is scheduled in the CRM after the account has been created.</li>
</ul>
<p>The business has an OLA in place that stipulates that new customers must be processed within a given time.  So that they can meet their OLA requirements, they want our workflow to complete within 10 minutes of the customer being taken on.  If the workflow does not complete within 10 minutes, the business wants the following to happen:</p>
<ul>
<li>Any placed sales call is to be cancelled.</li>
<li>The service desk takes over the process.</li>
</ul>
<p>Great - we know what they want.  So, let's start building it!</p>
<h1 id="our-architecture" tabindex="-1">Our architecture <a class="direct-link" href="#our-architecture">#</a></h1>
<p>Our architecture is very simple.  This is what it looks like:</p>
<p><img src="customer-onboarding-architecture.png" alt=""></p>
<p>There is a web API that serves as an entry point to let us know about the new customer.  There is a back end processing system that does all our processing.  There is also a CRM and a customer database.</p>
<p>We are going to build the entry point API and the back end processing system.  We are going to pretend that the CRM and the database exist.</p>
<p>Rebus will be used in the web API and the back end processing system.</p>
<h1 id="setting-up-the-projects" tabindex="-1">Setting up the projects <a class="direct-link" href="#setting-up-the-projects">#</a></h1>
<p>We're going to be using .Net 5, and I'll be using JetBrains Rider, but you can use your IDE of choice!  We're going to build everything so that it runs on our local machines and then migrate it to the Cloud later.  You can find the code in GitHub here:</p>
<p><a href="https://github.com/seankearon/rebus-onboardingcs.git">https://github.com/seankearon/rebus-onboardingcs.git</a></p>
<p>So that you can skip ahead, there are branches that have the outcomes of the stages as mentioned below.</p>
<p>The basic setup is to create a project for our Web API and a Console App project for our back end processor.  We'll call these EntryPointAPI and OnboardingProcessor respectively.  We'll see later how to run this locally, in an Azure App Service or a Windows Service.</p>
<p>Then we add the <a href="https://www.nuget.org/packages/Rebus">Rebus</a> and <a href="https://www.nuget.org/packages/Rebus.ServiceProvider">Rebus.ServiceProvider</a> NuGet packages to each project, giving us something like this:</p>
<p><img src="1-basic-project-cs.png" alt=""></p>
<p>This stage is available on the branch <em>1-basic-project-setup</em>.</p>
<h1 id="defining-our-messages" tabindex="-1">Defining our messages <a class="direct-link" href="#defining-our-messages">#</a></h1>
<p>So, now we have a couple of projects waiting for some code, we need to think about what we're going to build!  In a message-based system, a good place to start is designing your messages.</p>
<p>In Rebus, you model your messages as <a href="https://en.wikipedia.org/wiki/Plain_old_CLR_object">POCOs</a>.  Messages will be used by different parts of our system, so we'll put them into a shared assembly.  Messages should also be small and immutable.  (Rebus does allow mutating a message but, as processing is asynchronous, it's not a good idea as it can lead to unpredictable behaviour.  If you find you need to change the message state during processing then look at using another message to model the state changes.)</p>
<h2 id="events-and-commands" tabindex="-1">Events and commands <a class="direct-link" href="#events-and-commands">#</a></h2>
<p>Before we look at our requirements and start building our messages, let's take a moment to look at two types of messages.</p>
<p>Messages split into two broad categories: events and commands.  These correspond to the general meaning of the words with an event being a general notification that something has occurred (i.e. in the past), and a command is a when you tell a component to do something.</p>
<p>To send a command in Rebus you use either <code>IBus.Send()</code> or <code>IBus.SendLocal()</code> to send the message to a specific queue.  The difference between those calls is that with <code>IBus.Send()</code> you need to use Rebus' routing to tell Rebus where to send the message, but <code>IBus.SendLocal()</code> always sends the message to the current endpoint's queue.</p>
<h2 id="our-first-set-of-messages" tabindex="-1">Our first set of messages <a class="direct-link" href="#our-first-set-of-messages">#</a></h2>
<p>Let's leave the OLA requirements to one side for now and look at our main requirements.  These say that when a customer is onboarded that:</p>
<ul>
<li>An account is to be created for the customer.</li>
<li>A welcome email is to be sent to the customer after the account is created.</li>
<li>A sales call is scheduled in the CRM after the account has been created.</li>
</ul>
<p>So, if we were sitting in a room together and someone was telling us what to do, they'd probably say something like this:</p>
<p>&quot;Create an account for Sean.&quot;<br>
&quot;Account created for Sean.&quot;<br>
&quot;Send a welcome email to Sean.&quot;<br>
&quot;Schedule a sales call with Sean.&quot;<br>
&quot;Welcome email sent to Sean&quot;<br>
&quot;Sales call scheduled with to Sean&quot;</p>
<p>Someone is listening and ticks off what has been done.  If the process doesn't finish in time then they tell everyone to stop.  Check if the sales call should be cancelled and tell the service desk to take over.</p>
<p>So, that looks like three commands and an event to me!  As it's good for messages to be immutable, let's use C# 9's new records feature to implement our messages, which gives us:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">OnboardNewCustomer</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name  <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">CreateCustomerAccount</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Name  <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">CustomerAccountCreated</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Email      <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span>    CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">SendWelcomeEmail</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">WelcomeEmailSent</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">ScheduleSalesCall</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">record</span> <span class="token class-name">SalesCallScheduled</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span> CustomerId <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">init</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Generally, you will want your messages to contain as little information as possible.  After the customer has been created, we then use the ID of the customer.  We use the <code>CustomerAccountCreated</code> message to let us know what ID the new customer has been assigned.  We will see how that is used later.</p>
<p>This stage is available on the branch <em>2-main-messages-added</em></p>
<h1 id="creating-the-web-api-entry-point" tabindex="-1">Creating the web API entry point <a class="direct-link" href="#creating-the-web-api-entry-point">#</a></h1>
<p>The next job is to make our web API tell the backend about any new customers.  We'll just add a simple route to allow posting of a name and email.</p>
<blockquote>
<p>POST /newcustomer?name=my name&amp;email=me@my.email</p>
</blockquote>
<p>When we receive such a <code>POST</code> request then we will start the onboarding process by sending a <code>CreateCustomerAccount</code> message to the bus and respond with a <code>200 OK</code>.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OnboardNewCustomer</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> name<span class="token punctuation">,</span> Email <span class="token operator">=</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>To do this, we need to set up Rebus in our web API.  There are two basic modes of operation for Rebus &quot;out of the box&quot;: normal and one-way client.  The one-way client mode &quot;does what it says on the tin&quot; and allows you to send messages from a component.  In normal mode, Rebus can send and receive messages.  You can read more about those <a href="https://github.com/rebus-org/Rebus/wiki/Different-bus-modes">here</a>.</p>
<p>We are going to set up Rebus inside our .Net 5 web API and inject an instance of the Rebus <code>IBus</code> into our controller.  Remember, at this stage, we are just using the file system as our transport and will be adding Azure later.  In time-honoured fashion, let's use an extension method to configure and register an <code>IBus</code> instance and then inject that into our controller.</p>
<p>In <code>Startup.cs</code> we will add one call to our configure services method:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddControllers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token range operator">..</span><span class="token punctuation">.</span>

    <span class="token comment">// This configures and registers Rebus.</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebusAsOneWayClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>In our controller, we add a constructor parameter for the <code>IBus</code> so that it will be injected into the instance.  Our controller method can then send the message to the bus, making our controller class look like this:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">ApiController</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomerController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ControllerBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IBus</span> _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CustomerController</span><span class="token punctuation">(</span><span class="token class-name">IBus</span> bus<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpPost</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Route</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"newcustomer"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task<span class="token punctuation">&lt;</span>IActionResult<span class="token punctuation">></span></span> <span class="token function">NewCustomer</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> name<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> email<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">OnboardNewCustomer</span> <span class="token punctuation">{</span> Name <span class="token operator">=</span> name<span class="token punctuation">,</span> Email <span class="token operator">=</span> email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Pretty simple, right?  All that remains now is to look at the configuration in our extension method.  This looks like:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRebusAsOneWayClient</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebus</span><span class="token punctuation">(</span>
        cfg <span class="token operator">=></span> cfg
           <span class="token punctuation">.</span>Logging   <span class="token punctuation">(</span>l <span class="token operator">=></span> l<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                                               <span class="token comment">// A</span>
           <span class="token punctuation">.</span>Routing   <span class="token punctuation">(</span>r <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">TypeBased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token comment">// B</span>
           <span class="token punctuation">.</span>Transport <span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">UseFileSystemAsOneWayClient</span><span class="token punctuation">(</span><span class="token string">"c:/rebus-advent"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token comment">// C</span>
           <span class="token punctuation">.</span>Options   <span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">SimpleRetryStrategy</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">errorQueueAddress</span><span class="token punctuation">:</span> <span class="token string">"ErrorQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// D</span>
<span class="token punctuation">}</span></code></pre>
<p>So, in our configuration we do the following:</p>
<p><strong>A:</strong> We tell Rebus to log to the console.</p>
<p><strong>B:</strong> We tell Rebus where to send the <code>OnboardNewCustomer</code> messages.  In Rebus, messages go to &quot;queues&quot;.</p>
<p><strong>C:</strong> we tell Rebus to use the file system to transport messages, and we tell Rebus that we will only ever be sending messages.</p>
<p><strong>D:</strong> we tell Rebus to retry any failures (the default is 5 times, but you can set that as you wish) and to send messages that are still failing log to the queue called &quot;ErrorQueue&quot;.</p>
<p>This configuration will change a little later when we use Azure ServiceBus as our message transport.  But, we're now ready to start sending messages.  Woohoo!</p>
<p>The code at this point is available in the branch <code>3-entry-point-api-working</code>.  Go and run that, crank up your favourite HTTP tool and send the following to your new API (don't forget to add the host!):</p>
<blockquote>
<p>POST /newcustomer?name=Sean&amp;email=sean@my.email</p>
</blockquote>
<p><strong>Aside:</strong> If you're using Rider, you can run the line above from  <a href="https://www.jetbrains.com/help/rider/Http_client_in__product__code_editor.html">Rider's built-in HTTP client</a>.  How cool is that? :)</p>
<p>Then you will see a file has appeared in <code>c:/rebus-advent/MainQueue</code>.  We can just open that up to see that a message in Rebus consists of a set of headers and a body:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"Headers"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"rbs2-intent"</span><span class="token operator">:</span> <span class="token string">"p2p"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-msg-id"</span><span class="token operator">:</span> <span class="token string">"323e07bb-4dd2-43b4-af5d-9c5749742cd7"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-senttime"</span><span class="token operator">:</span> <span class="token string">"2020-11-10T11:17:26.1492853+00:00"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-msg-type"</span><span class="token operator">:</span> <span class="token string">"OnboardingMessages.OnboardNewCustomer, OnboardingMessages"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-corr-id"</span><span class="token operator">:</span> <span class="token string">"323e07bb-4dd2-43b4-af5d-9c5749742cd7"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-corr-seq"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
        <span class="token property">"rbs2-content-type"</span><span class="token operator">:</span> <span class="token string">"application/json;charset=utf-8"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"Body"</span><span class="token operator">:</span> <span class="token string">"eyIkdHlwZSI6Ik9uYm9hcmRpbmdNZXNzYWdlcy5PbmJvYXJkTmV3Q3VzdG9tZXIsIE9uYm9hcmRpbmdNZXNzYWdlcyIsIk5hbWUiOiJTZWFuIiwiRW1haWwiOiJzZWFuQG15LmVtYWlsIn0="</span>
<span class="token punctuation">}</span></code></pre>
<p>The body is Base64 encoded JSON that is our serialised message:</p>
<pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">"$type"</span><span class="token operator">:</span> <span class="token string">"OnboardingMessages.OnboardNewCustomer, OnboardingMessages"</span><span class="token punctuation">,</span>
    <span class="token property">"Name"</span><span class="token operator">:</span> <span class="token string">"Sean"</span><span class="token punctuation">,</span>
    <span class="token property">"Email"</span><span class="token operator">:</span> <span class="token string">"sean@my.email"</span>
<span class="token punctuation">}</span></code></pre>
<h1 id="a-quick-review" tabindex="-1">A quick review <a class="direct-link" href="#a-quick-review">#</a></h1>
<p>So, to add Rebus to our normal .Net Web API project we have:</p>
<ul>
<li>Defined our messages.</li>
<li>Added around 4 lines of configuration.</li>
<li>Registered Rebus into .Net 5's DI.</li>
<li>Sent the message into our bus directly from our controller method.</li>
</ul>
<p>Because of the reliability and durability that Rebus' brings, any client that calls our <code>/newcustomer</code> API and receives a <code>200 OK</code> knows that the onboarding process has now started and that it will be processed as expected.</p>
<p>That's a good start!  Let's move on to creating the back end of our system that is going to process the messages from the API.</p>
<h1 id="creating-the-back-end" tabindex="-1">Creating the back end <a class="direct-link" href="#creating-the-back-end">#</a></h1>
<p>The way we set up Rebus in the back end is going to be very similar to how we did that in the API.  There are some essential differences that we will focus on:</p>
<ul>
<li>The back end needs to send <em>and</em> receive messages.</li>
<li>The back end will be performing a long-running, durable workflow/saga.</li>
<li>We want to be able to host the back end in an Azure App Service, as well as run it locally (and, possibly, in a Windows Service).</li>
</ul>
<h2 id="configuring-rebus-for-send-and-receive" tabindex="-1">Configuring Rebus for send and receive <a class="direct-link" href="#configuring-rebus-for-send-and-receive">#</a></h2>
<p>Next, we are going to configure Rebus for our back end.  So that we can run locally or in an Azure App Service, we are going to use a library called <a href="https://github.com/rebus-org/Topper">Topper</a> form the creator of rebus, Mogens (here's <a href="https://rebus.fm/2019/01/29/generic-host/">Mogens' blog</a> introducing Topper..  Under the hood, Topper uses the venerable <a href="http://topshelf-project.com/">Topshelf library</a> and requires us to implement our back end as an <code>IDisposable</code> wrapper and run it inside a Console application project.</p>
<p>I'm going to sprinkle in a little bit of <a href="https://github.com/serilog/serilog">Serilog</a> too, just for fun.  Our entry point will look like the following:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Program</span>
<span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span>Logger <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">LoggerConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span>WriteTo<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">CreateLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name"><span class="token keyword">var</span></span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">"OurBackendBus"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Backend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ServiceHost<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>That all we need to do to set up for running locally or in Azure.  We can also create and run it as a Windows Service just by calling the executable using the parameter <code>install</code> (use <code>uninstall</code> to remove the service).  Very cool!</p>
<p>The rest of the magic all happens in our <code>Backend</code> class.  Let's take a look at that class:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Backend</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDisposable</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ServiceProvider</span> _provider<span class="token punctuation">;</span>
    <span class="token keyword">private</span>          <span class="token class-name">IBus</span>            _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">Backend</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name"><span class="token keyword">var</span></span> services <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ServiceCollection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        services<span class="token punctuation">.</span><span class="token function">AddRebusAsSendAndReceive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _provider <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">BuildServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _provider<span class="token punctuation">.</span><span class="token function">UseRebus</span><span class="token punctuation">(</span>x <span class="token operator">=></span> _bus <span class="token operator">=</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus<span class="token punctuation">?.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _provider<span class="token punctuation">?.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>And, like previously, we've put the configuration spell into an extension method, which looks like this:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRebusAsSendAndReceive</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebus</span><span class="token punctuation">(</span>
        cfg <span class="token operator">=></span> cfg
           <span class="token punctuation">.</span><span class="token function">Logging</span><span class="token punctuation">(</span>l <span class="token operator">=></span> l<span class="token punctuation">.</span><span class="token function">Serilog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Routing</span><span class="token punctuation">(</span>r <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">TypeBased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">MapAssemblyOf</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Transport</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">UseFileSystem</span><span class="token punctuation">(</span><span class="token string">"c:/rebus-advent"</span><span class="token punctuation">,</span> <span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Options</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">SimpleRetryStrategy</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">errorQueueAddress</span><span class="token punctuation">:</span> <span class="token string">"ErrorQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Sagas</span><span class="token punctuation">(</span>s <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">UseFilesystem</span><span class="token punctuation">(</span><span class="token string">"c:/rebus-advent/sagas"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AutoRegisterHandlersFromAssemblyOf</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Backend<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This is very similar to the previous one, but we are not using the <code>*AsOneWayClient</code> flavours of the configuration methods.  We are going to be dealing with more than one message in our back end, so the routing maps all messages from the assembly to our <code>MainQueue</code>.  The file system transport is two-way and therefore needs to know which queue to work against - that's <code>MainQueue</code> again.  Lastly, we've got a new configuration item to set us up ready for our sagas later on.</p>
<p>There is one new line that we haven't seen before now: <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;();</code>.  This tells Rebus to scan the assembly to find and register handlers, which in Rebus are types that will process messages.  You can now test that the lovely new backend is working by adding a handler for the <code>OnboardNewCustomer</code> message, as follows:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DummyHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">OnboardNewCustomer</span> message<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>If you have a message waiting in the queue from before, then this will be found and Rebus will pass it to the handler above and can break in your IDE to see that the data from our earlier message is passed into our handler.  If you don't have a message waiting, just use the API to send one.</p>
<p><img src="cs-break-in-handler.png" alt=""></p>
<p>You can also see the logging output in the console:</p>
<p><img src="rebus-console-output.png" alt=""></p>
<p>If you allow the program to run, you'll see in the console that Rebus will retry the message 5 times - getting our <code>NotImplementedException</code> each time, and then the message is moved to our <code>ErrorQueue</code>:</p>
<p><img src="message-in-error-queue-filesystem.png" alt=""></p>
<p>Just drag it back to the <code>MainQueue</code> to start processing again!</p>
<p>You can find the code at this point on the branch <code>4-back-end-configuration</code>.</p>
<p><strong>Aside:</strong>  Did you see what happened there?  Our system didn't stop working just because the back end component was down (okay, not even written yet!!).  The message stayed in the queue and waited until there was something to process it.  That's a nice example of how using Rebus increases the reliability of your system.</p>
<h2 id="creating-the-saga" tabindex="-1">Creating the saga <a class="direct-link" href="#creating-the-saga">#</a></h2>
<p>Okay, we're ready now to create our saga, the code that will run our workflow.  Rebus models sagas by implementing two connected classes.  One that holds any state that changes throughout the workflow, and one that is responsible for coordinating the work done throughout the long-running process.  This is what the basic structures look like:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnboardingSagaData</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISagaData</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id       <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span>  Revision <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnboardingSaga</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Saga<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span><span class="token punctuation">,</span> <span class="token class-name">IAmInitiatedBy<span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CorrelateMessages</span><span class="token punctuation">(</span><span class="token class-name">ICorrelationConfig<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span> config<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">OnboardNewCustomer</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token range operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The <code>OnboardingSagaData</code> class has the <code>Id</code> and <code>Revision</code> properties from the <code>ISagaData</code> interface so that Rebus can control concurrent access to the saga's state for us.</p>
<p>Each time a customer is onboarded, there will be a saga instance that is responsible for controlling the onboarding workflow for that customer.  The <code>CorrelateMessages</code> method in the  <code>OnboardingSaga</code> class is used by Rebus to find the saga instance that relates to a particular message.</p>
<p>We tell Rebus when to start a new saga by adding the interface <code>IAmInitiatedBy&lt;OnboardNewCustomer&gt;</code>.  Soon, we will add other messages that will be processed by the saga by using the <code>IHandleMessages&lt;T&gt;</code> interface.</p>
<p>Let's push on and see how this is implemented for the full workflow (except the OLA requirements).</p>
<p>We need to track what's going on in our workflow.  We do that by adding state to the <code>ISagaData</code> implementation.  We're going to keep hold of the name, email and the new account id and we also want to track what actions have happened.   I've added the <code>IsComplete</code> helper property that we'll use in the saga.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnboardingSagaData</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ISagaData</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Guid</span> Id       <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span>  Revision <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CustomerName  <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> CustomerEmail <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">int</span></span>    AccountId     <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> AccountCreated     <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> WelcomeEmailSent   <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> SalesCallScheduled <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">bool</span></span> IsComplete <span class="token operator">=></span> AccountCreated <span class="token operator">&amp;&amp;</span> WelcomeEmailSent <span class="token operator">&amp;&amp;</span> SalesCallScheduled<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We update the state from inside the handlers in our saga (Rebus makes the saga's data available via the instance's <code>Data</code> property).  For example, when we get a confirmation that the welcome email has been sent:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">WelcomeEmailSent</span> m<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Data<span class="token punctuation">.</span>WelcomeEmailSent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompetedTask<span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>At the exit of each handler method, we call <code>TryComplete()</code>.  This method checks to see that we've done everything we want to do and, if so, we call the Rebus' <code>MarkAsComplete()</code> method.   Rebus will then remove clean up and remove the saga's state for us.  We call this every time as Rebus, being distributed and asynchronous, may have finished up the saga in the blink of an eye!  (Okay, we probably don't need to call it at the end of the initiating method, but I like to do that for consistency!)  This is our <code>TryComplete()</code> method:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Data<span class="token punctuation">.</span>IsComplete<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token function">MarkAsComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Rebus needs to know how to find the saga state for our particular workflow, and we have updated the <code>CorrelateMessages</code> method with the necessary code to let Rebus do just that:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CorrelateMessages</span><span class="token punctuation">(</span><span class="token class-name">ICorrelationConfig<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span> config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span>    <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>      <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>CustomerEmail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomerAccountCreated<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>      <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>CustomerEmail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WelcomeEmailSent<span class="token punctuation">></span></span></span>      <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>AccountId<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>AccountId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SalesCallScheduled<span class="token punctuation">></span></span></span>    <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>AccountId<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>AccountId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The configuration allows you to correlate a property value in each message handled by the saga with a value in the saga's state.  You just need to make sure Rebus can uniquely identify the saga from these values and then sit back and let Rebus do all the finding for you!  We're using the email and the account ID when it's known.  Note that you need to supply a correlation for Rebus to identify all messages to which the saga responds, including the message that initiates the saga.</p>
<p>All that remains is to do some work inside the saga.  Generally, I like to keep my sagas pretty &quot;slim&quot; and make them responsible for coordinating the flow of work.  I tend to pass off work to other handlers by sending messages out from the saga.  Here's how that looks in the saga's initiating handler:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">OnboardNewCustomer</span> m<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IsNew<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

    Data<span class="token punctuation">.</span>CustomerName  <span class="token operator">=</span> m<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
    Data<span class="token punctuation">.</span>CustomerEmail <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">;</span>

    <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CreateCustomerAccount</span> <span class="token punctuation">{</span>Name <span class="token operator">=</span> m<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Email <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>In the first line we check that the saga hasn't already been created by another process and abandon if so.  Then, after setting some state, we use the Rebus <code>IBus</code> instance has been injected into our saga to send a command message to create an account for the customer details we have been given.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CreateCustomerAccount</span> <span class="token punctuation">{</span>Name <span class="token operator">=</span> m<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Email <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>As our requirements say that everything else should happen <em>after</em> the account has been created, that's all we need to do there.</p>
<p>The full code looks like this:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnboardingSaga</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Saga<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IAmInitiatedBy<span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>CustomerAccountCreated<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>WelcomeEmailSent<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>SalesCallScheduled<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IBus</span> _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">OnboardingSaga</span><span class="token punctuation">(</span><span class="token class-name">IBus</span> bus<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Data<span class="token punctuation">.</span>IsComplete<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">MarkAsComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CorrelateMessages</span><span class="token punctuation">(</span><span class="token class-name">ICorrelationConfig<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span> config<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span>    <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>     <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>CustomerEmail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>CustomerAccountCreated<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>Email<span class="token punctuation">,</span>     <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>CustomerEmail<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>WelcomeEmailSent<span class="token punctuation">></span></span></span>      <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>AccountId<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>AccountId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SalesCallScheduled<span class="token punctuation">></span></span></span>    <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>AccountId<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>AccountId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">OnboardNewCustomer</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>IsNew<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        Data<span class="token punctuation">.</span>CustomerName  <span class="token operator">=</span> m<span class="token punctuation">.</span>Name<span class="token punctuation">;</span>
        Data<span class="token punctuation">.</span>CustomerEmail <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">;</span>

        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CreateCustomerAccount</span> <span class="token punctuation">{</span>Name <span class="token operator">=</span> m<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> Email <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CustomerAccountCreated</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Data<span class="token punctuation">.</span>AccountId <span class="token operator">=</span> m<span class="token punctuation">.</span>AccountId<span class="token punctuation">;</span>
        Data<span class="token punctuation">.</span>AccountCreated <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SendWelcomeEmail</span>  <span class="token punctuation">{</span>AccountId <span class="token operator">=</span> Data<span class="token punctuation">.</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">ScheduleSalesCall</span> <span class="token punctuation">{</span>AccountId <span class="token operator">=</span> Data<span class="token punctuation">.</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">WelcomeEmailSent</span> _<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Data<span class="token punctuation">.</span>WelcomeEmailSent <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">SalesCallScheduled</span> _<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Data<span class="token punctuation">.</span>SalesCallScheduled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token function">TryComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The code at this stage is available in the branch <code>5-saga-receives-messages</code>.</p>
<p>If you check that out, run it and start the saga by posting to our API, then the message will fail and be placed in the error queue after be retried only once.  If you open up the message, you'll see something like this:</p>
<p><img src="failed-message-with-error-in-header.png" alt=""></p>
<p>Look inside the <code>rbs2-error-details</code> header and you will see that Rebus has stored the exception details in there for use.  They tell us this:</p>
<pre><code>Message with ID db52a43d-a6bc-4a9d-a6c3-3d4a324fcaba
and type OnboardingMessages.CreateCustomerAccount, OnboardingMessages
could not be dispatched to any handlers
(and will not be retried under the default fail-fast settings)
</code></pre>
<p>This lovely, helpful error shows what Rebus puts messages onto the error queue if it cannot find any handlers to process it.  The &quot;fail-fast&quot; part is Rebus' built-in mechanism to skip retries when you are sure there is no point.</p>
<h2 id="creating-the-remaining-handlers" tabindex="-1">Creating the remaining handlers <a class="direct-link" href="#creating-the-remaining-handlers">#</a></h2>
<p>In a real-world application, you might choose to create another Rebus endpoint for one or more of the handlers we are going to create.  This could be because you want to deploy it separately for performance or other reasons.  Rebus makes it easy to structure your application how you want.  For us, we're going to put them all into the single endpoint - that's fine too! :)</p>
<p>We need handlers that do the following:</p>
<ul>
<li>Create a customer account.</li>
<li>Send a welcome email.</li>
<li>Schedule a sales call.</li>
</ul>
<p>As we saw briefly above with our <code>DummyHandler</code>, a handler is just a class that implements the <code>IHandleMessages&lt;T&gt;</code> interface.  So, we need the following handlers:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CreateCustomerAccountHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>CreateCustomerAccount<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IBus</span> _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">CreateCustomerAccountHandler</span><span class="token punctuation">(</span><span class="token class-name">IBus</span> bus<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CreateCustomerAccount</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Pretend we're doing something!</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Reply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CustomerAccountCreated</span> <span class="token punctuation">{</span>Email <span class="token operator">=</span> m<span class="token punctuation">.</span>Email<span class="token punctuation">,</span> AccountId <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendWelcomeEmailHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>SendWelcomeEmail<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IBus</span> _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">SendWelcomeEmailHandler</span><span class="token punctuation">(</span><span class="token class-name">IBus</span> bus<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">SendWelcomeEmail</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Pretend we're doing something!</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Reply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">WelcomeEmailSent</span> <span class="token punctuation">{</span> AccountId <span class="token operator">=</span> m<span class="token punctuation">.</span>AccountId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ScheduleSalesCallHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>ScheduleSalesCall<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">IBus</span> _bus<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">ScheduleSalesCallHandler</span><span class="token punctuation">(</span><span class="token class-name">IBus</span> bus<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        _bus <span class="token operator">=</span> bus<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">ScheduleSalesCall</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Pretend we're doing something!</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Reply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SalesCallScheduled</span> <span class="token punctuation">{</span> AccountId <span class="token operator">=</span> m<span class="token punctuation">.</span>AccountId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>The fact that we included the line <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;()</code> in our Rebus setup means that we can put those handlers anywhere in our back end project.  Rebus will find them and set them up so that they are ready to use.</p>
<p>You will notice that each handler notifies the saga that it was completed, sometimes passing back new information - such as the account ID.  It's perfectly possible to use the <code>IBus.Send*()</code> methods to do that.  But, I'm using  <code>IBus.Reply()</code> which replies to the Rebus endpoint/queue that the message came from.  That is a nice way to avoid having to think about whether I've configured the routing for that message!</p>
<p>One of the joys of developing against the file system transport is that you can easily look into what Rebus is doing.  Just put a breakpoint in one of your handlers, use the API to start the onboarding process and you'll see the messages and saga state being updated on disk as you step through.</p>
<p><img src="saga-in-action-filesystem.png" alt=""></p>
<p>Congratulations!  If you've followed this far, you now have a long-running, durable workflow implemented in Rebus!</p>
<p>You can get this code at this point from the branch <code>6-saga-processes-messages</code>.  I've added some logging to that so that you can watch things happening from the console too, so you should see something like this:</p>
<p><img src="saga-logging-output.png" alt=""></p>
<p><strong>Aside:</strong> There are two versions of this post - one using C# and one using F#.  Just for fun, why not try running the API from the <a href="https://github.com/seankearon/rebus-onboardingcs">C# project</a> and the backend from the <a href="https://github.com/seankearon/rebus-onboardingfs">F# project</a>?  As long as you're using the same transport (at this stage that's file-system in <code>c:\rebus-advent</code>) then everything will work just fine.  How lovely is that? :)</p>
<h2 id="adding-ola-support" tabindex="-1">Adding OLA support <a class="direct-link" href="#adding-ola-support">#</a></h2>
<p>Okay, so that's most of our requirements covered.  We only have the OLA to add in.  The requirement was that if the workflow does not complete within 10 minutes, the business want the following to happen:</p>
<ul>
<li>Any placed sales call is to be cancelled.</li>
<li>The service desk takes over the process.</li>
</ul>
<p>To implement this, we're going to use a cool Rebus feature: deferred messages (which are talked about in the <a href="https://github.com/rebus-org/Rebus/wiki/Timeout-Manager">timeout manager section</a> of the Rebus wiki).  Using this feature we can send ourselves a message that will be received at a time in the future.  If that message is received before the saga completes then we know that our time is up!  We send it like this:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Defer</span><span class="token punctuation">(</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">OnboardingOlaBreached</span> <span class="token punctuation">{</span>SagaId <span class="token operator">=</span> Data<span class="token punctuation">.</span>Id<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>When we get that, we just handle it like any other message.  Here's the handler to meet our OLA breach requirements:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">OnboardingOlaBreached</span> m<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>Data<span class="token punctuation">.</span>SalesCallScheduled<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">CancelSalesCall</span> <span class="token punctuation">{</span>AccountId <span class="token operator">=</span> Data<span class="token punctuation">.</span>AccountId<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotifyServiceDesk</span> <span class="token punctuation">{</span>Message <span class="token operator">=</span> <span class="token interpolation-string"><span class="token string">$"Customer onboarding OLA breach pending for new customer </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Data<span class="token punctuation">.</span>CustomerName</span><span class="token punctuation">}</span></span><span class="token string"> with email </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">Data<span class="token punctuation">.</span>CustomerEmail</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">MarkAsComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We send a message to cancel the sales call and then send another message to notify the service desk that bad things are about to happen!  After that, we call <code>MarkAsComplete()</code> to close the saga.</p>
<p>Don't forget that we need to set up a correlation for our timeout message and add the interface to the saga's signature:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CorrelateMessages</span><span class="token punctuation">(</span><span class="token class-name">ICorrelationConfig<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span> config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// snip</span>
    config<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Correlate</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardingOlaBreached<span class="token punctuation">></span></span></span> <span class="token punctuation">(</span>x <span class="token operator">=></span> x<span class="token punctuation">.</span>SagaId<span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>OnboardingSagaData<span class="token punctuation">.</span>Id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OnboardingSaga</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Saga<span class="token punctuation">&lt;</span>OnboardingSagaData<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IAmInitiatedBy<span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>CustomerAccountCreated<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>WelcomeEmailSent<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>SalesCallScheduled<span class="token punctuation">></span></span>
                            <span class="token punctuation">,</span> <span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>OnboardingOlaBreached<span class="token punctuation">></span></span></span></code></pre>
<p>We need to add a couple of handlers that will respond to our new fire-and-forget messages.  As these are not responding, they are simpler creatures:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CancelSalesCallHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>CancelSalesCall<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">CancelSalesCall</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Cancelling sales call for account </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">m<span class="token punctuation">.</span>AccountId</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotifyServiceDeskHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>NotifyServiceDesk<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">NotifyServiceDesk</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Log<span class="token punctuation">.</span><span class="token function">Information</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Notifying the service desk that: </span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">m<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> Task<span class="token punctuation">.</span>CompletedTask<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Lastly, we need to update the configuration spell to tell Rebus where to store timeouts.  We're going to store those in the file system for now:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRebusAsSendAndReceive</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebus</span><span class="token punctuation">(</span>
        cfg <span class="token operator">=></span> cfg
           <span class="token comment">// snip</span>
           <span class="token punctuation">.</span><span class="token function">Timeouts</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">UseFileSystem</span><span class="token punctuation">(</span><span class="token string">"c:/rebus-advent/timeouts"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>That's all we need to meet the remaining requirements around the OLA and compensating actions.  In the code, we hard wired a 5-second timeout, so we can easily see the timeout in action by increasing the pretend delay in one of our handlers.</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendWelcomeEmailHandler</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHandleMessages<span class="token punctuation">&lt;</span>SendWelcomeEmail<span class="token punctuation">></span></span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">Handle</span><span class="token punctuation">(</span><span class="token class-name">SendWelcomeEmail</span> m<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// This delay will breach our OLA rules!</span>
        <span class="token keyword">await</span> _bus<span class="token punctuation">.</span><span class="token function">Reply</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">WelcomeEmailSent</span> <span class="token punctuation">{</span> AccountId <span class="token operator">=</span> m<span class="token punctuation">.</span>AccountId <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Now, when we run the saga we will see the delay causing the OLA to become breached and the compensating actions taking over.</p>
<p><img src="saga-logging-output-breached-ola.png" alt=""></p>
<p>The code at this point is in the branch <code>7-ola-and-compensating-actions</code>.</p>
<h1 id="migrating-to-the-cloud" tabindex="-1">Migrating to the Cloud <a class="direct-link" href="#migrating-to-the-cloud">#</a></h1>
<p>What we have at this point will run in the IDE and can easily be installed as a Windows Service, as mentioned earlier.  All that remains now is to show how easy it is to migrate this to the cloud and run it in an Azure App Service.</p>
<p>As we do this, you'll notice that all we change is the configuration and the functionality remains the same.  That's pretty awesome!  (Okay, sure, I've added some code to get the .Net <code>IConfiguration</code>, but that doesn't count. :) )</p>
<p>We have two App Services that will host our entry point API and the back end processing system.  Instead of the file system, we will be using Azure Service Bus for our message transport and a SQL Azure database to store our saga state.</p>
<p><img src="azure-architecture.png" alt=""></p>
<p>As you know, we're using  <a href="https://github.com/rebus-org/Topper">Topper</a> so that we can easily run our Rebus back end in the Azure App Service as continuous Web Job.  This means we need to have the App Service configured as <em>always on</em>.  We need to create a database for Rebus to use, but we're Rebus will create the tables if they don't already exist.  The same is true for the queues in our Azure Service Bus.  We need to change our configuration spells a little so that we can use these Azure resources.</p>
<p><strong>Aside:</strong> In my production systems, I like to control the configuration based on a value in <code>appsettings.json</code>.  That means I always have my local file system transport set up and ready for any debugging I might want to do locally.</p>
<p>We need to add the <a href="https://www.nuget.org/packages/Rebus.AzureServiceBus">Rebus.AzureServiceBus NuGet</a> to our API and back end projects, and the <a href="https://www.nuget.org/packages/Rebus.SqlServer">Rebus.SqlServer</a> to our back end project.  I'm using a basic SQL Azure database that costs £3.72 per month.  That should be adequate until start onboarding a lot of customers!</p>
<p><strong>Aside:</strong> To avoid making our connections strings visible in our code, we're going to use .Net 5's built-in <a href="https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0&amp;tabs=windows">secret management</a>.  You could also just store those in your <code>appsettings.json</code> while testing the code and not check them in!</p>
<p>You can access your Azure Service Bus connection string from the <strong>Shared access policies</strong> in the portal:</p>
<p><img src="azure-service-bus-connection-string.png" alt=""></p>
<p><strong>Tip:</strong> you can set your user secrets from the command line in the project folder: <code>dotnet user-secrets set &quot;ConnectionStrings:MsSqlConnectionString&quot; &quot;you connection string&quot;</code>.</p>
<p>Here is the adjusted configuration spell for the back end:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRebusAsSendAndReceive</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebus</span><span class="token punctuation">(</span>
        rebus <span class="token operator">=></span> rebus
           <span class="token punctuation">.</span>Logging  <span class="token punctuation">(</span>l <span class="token operator">=></span> l<span class="token punctuation">.</span><span class="token function">Serilog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span>Routing  <span class="token punctuation">(</span>r <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">TypeBased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">MapAssemblyOf</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Transport</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">UseAzureServiceBus</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"AzureServiceBusConnectionString"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">AutomaticallyRenewPeekLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span>Options  <span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">SimpleRetryStrategy</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">errorQueueAddress</span><span class="token punctuation">:</span> <span class="token string">"ErrorQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span>Options  <span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">EnableMessageAuditing</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">auditQueue</span><span class="token punctuation">:</span> <span class="token string">"AuditQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span>Sagas    <span class="token punctuation">(</span>s <span class="token operator">=></span> s<span class="token punctuation">.</span><span class="token function">StoreInSqlServer</span><span class="token punctuation">(</span>config<span class="token punctuation">[</span><span class="token string">"MsSqlConnectionString"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"Sagas"</span><span class="token punctuation">,</span> <span class="token string">"SagaIndexes"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AutoRegisterHandlersFromAssemblyOf</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Backend<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>You can see that the <code>.Transport</code> has changed to use Azure Service Bus (and that we allow Rebus to automatically renew peek locks on our behalf) and that the <code>.Sagas</code> configuration now uses SQL Server.  If you're paying attention, you might have noticed that there is no longer an item to configure timeout storage.  That is because Rebus is using native behaviour in Azure Service Bus to achieve that (as it does with subscription storage, which is beyond the scope of this article). Nice!</p>
<p>Just so we can see what's happened, we've turned on message auditing using <code>.EnableMessageAuditing(...)</code>.  Rebus will now put a copy of every processed message into the queue we nominate.</p>
<p>The configuration spell for the API is adjusted similarly:</p>
<pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">AddRebusAsOneWayClient</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">,</span> <span class="token class-name">IConfiguration</span> config<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddRebus</span><span class="token punctuation">(</span>
        rebus <span class="token operator">=></span> rebus
           <span class="token punctuation">.</span><span class="token function">Logging</span><span class="token punctuation">(</span>l <span class="token operator">=></span> l<span class="token punctuation">.</span><span class="token function">Console</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Routing</span><span class="token punctuation">(</span>r <span class="token operator">=></span> r<span class="token punctuation">.</span><span class="token function">TypeBased</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Map</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>OnboardNewCustomer<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token string">"MainQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Transport</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">UseAzureServiceBusAsOneWayClient</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetConnectionString</span><span class="token punctuation">(</span><span class="token string">"AzureServiceBusConnectionString"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
           <span class="token punctuation">.</span><span class="token function">Options</span><span class="token punctuation">(</span>t <span class="token operator">=></span> t<span class="token punctuation">.</span><span class="token function">SimpleRetryStrategy</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">errorQueueAddress</span><span class="token punctuation">:</span> <span class="token string">"ErrorQueue"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>Note:</strong> Make sure that you update the <a href="https://www.nuget.org/packages/Microsoft.Azure.ServiceBus">Microsoft.Azure.ServiceBus NuGet</a> package to 5.0.0 or above or you might see an error like this when sending messages from the API:</p>
<p><code>Rebus.Exceptions.RebusApplicationException: Could not send to queue 'MainQueue' ---&gt; System.InvalidOperationException: Operation is not valid due to the current state of the object.</code></p>
<p>So, we can now run locally just the same as we before, but our messages will be stored in Azure Service Bus and sagas in SQL Azure (don't forget to allow access to SQL Azure from your local IP address!).  Run just the API and post to our <code>/newcustomer</code> route and you will see there is a message in Azure Service Bus:</p>
<p><img src="azure-service-bus-message-peek.png" alt=""></p>
<p>Run the back end project and you will see in the console that Rebus has created tables and queues for us before processing the waiting message:</p>
<p><img src="rebus-console-azure-backend-first-run.png" alt=""></p>
<p>We now just need to publish our two projects and we'll have our onboarding process running in Azure.  Before you do that, you will need to set up your connection strings in your App Service:</p>
<p><img src="azure-app-service-configuration.png" alt=""></p>
<p>To publish our backend processor as a Web Job we'll use Visual Studio (as Rider's Azure integration doesn't include Web Job support - but, hey, who knows what we might get for Xmas! :) ).  The process is pretty simple and you can create your App Services along the way if you want:</p>
<p><img src="visual-studio-publish.png" alt=""></p>
<p><strong>Tip:</strong> Make sure you set your Web Job to be continuous when you publish:</p>
<p><img src="visual-studio-publish-ensure-continuous.png" alt=""></p>
<p>After you've published, check that your back end is working by looking in the Web Job section:</p>
<p><img src="azure-app-service-web-job-running.png" alt=""></p>
<p>If it's not running, click on logs to the output and diagnose.  Once it is running then you should be able to post to the <code>/newcustomer</code> API and see the same output we saw in our console in the Web Job logs:</p>
<p><img src="azure-web-job-log-processed.png" alt=""></p>
<p>Congratulations - you now have your onboarding business process running in an Azure App Service Web Job and your API entry point running in Azure App Service.</p>
<p>The code at this point is in the branch <code>8-running-in-azure</code>.</p>
<p>Enjoy Rebus!</p>


      </div>
    </div>
  </div>
</article>


<hr>

<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-md-10 mx-auto">
        <p class="copyright text-muted">Copyright &copy; Sean Kearon 2020</p>
      </div>
    </div>
  </div>
</footer>

<!-- Bootstrap core JavaScript -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.bundle.min.js" integrity="sha512-igl8WEUuas9k5dtnhKqyyld6TzzRjvMqLC79jkgT3z02FvJyHAuUtyemm/P/jYSne1xwFI06ezQxEwweaiV7VA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<ul><li>Next: <a href="/posts/2020/12/rebus-sagas-fsharp/">Long-running business processes in F# with Rebus on Azure</a></li><li>Previous: <a href="/posts/2020/11/using-powershell-to-set-sql-azure-firewall/">Use PowerShell to create a SQL Azure firewall rule for your current IP</a></li>
</ul>

<script src="https://utteranc.es/client.js"
        repo="seankearon/seankearon.github.io"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

    </main>

    <footer></footer>

    <!-- Current page: /posts/2020/12/rebus-sagas-csharp/ -->
  </body>
</html>
