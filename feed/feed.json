{
  "version": "https://jsonfeed.org/version/1",
  "title": "Atlantic Breeze",
  "home_page_url": "https://seankearon.me/",
  "feed_url": "https://seankearon.me/feed/feed.json",
  "description": "The technical blog of Sean Kearon",
  "author": {
    "name": "Sean Kearon",
    "url": "https://seankearon.me/about/"
  },
  "items": [{
      "id": "https://seankearon.me/posts/2024/04/rebus-worker-service-csharp/",
      "url": "https://seankearon.me/posts/2024/04/rebus-worker-service-csharp/",
      "title": "Running Rebus in a .Net Worker Service",
      "content_html": "<p>In this article we are going to show how to run a Rebus service bus inside of .Net Worker.</p>\n<!-- more -->\n<h1 id=\"introduction-to-rebus\" tabindex=\"-1\">Introduction to Rebus <a class=\"direct-link\" href=\"#introduction-to-rebus\">#</a></h1>\n<p><a href=\"https://rebus.fm/what-is-rebus/\">Rebus</a> is an open-source, distributed, asynchronous and durable .Net Service Bus that is both very a powerful way to build applications and microservices, and it is a real pleasure to develop with.  It is similar to other .Net Service Buses such as NServiceBus, Mass Transit or EasyNetQ.</p>\n<p>Rebus has a focus on simplicity and is very easy to embed into any part of your application (with the possible exception of mobile apps and embedded).  If you are not already familiar, here are some links to help you get started:</p>\n<ul>\n<li><a href=\"https://rebus.fm/what-is-rebus/\">A description from Rebus' main website</a></li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki\">The main documentation wiki on GitHub</a></li>\n<li><a href=\"https://github.com/rebus-org/Rebus\">The main repository on GitHub</a></li>\n</ul>\n<p>You might also find my previous article useful, <a href=\"https://seankearon.me/posts/2020/12/rebus-sagas-csharp/\">Long-running business processes in C# with Rebus on Azure</a>.  There is an equivalent article using F# <a href=\"https://seankearon.me/posts/2020/12/rebus-sagas-fsharp/\">here</a>.</p>\n<h1 id=\"introduction-to-.net-worker-services\" tabindex=\"-1\">Introduction to .Net worker services <a class=\"direct-link\" href=\"#introduction-to-.net-worker-services\">#</a></h1>\n<p>.Net Workers are a way to host a background service in .Net.  Typically, you would use them for building long-running processes like Windows Services or a Linux deamons.  You can also run .Net workers in console apps, desktop apps, and <a href=\"http://ASP.Net\">ASP.Net</a> background tasks.  Here are some links for further reading:</p>\n<ul>\n<li><a href=\"https://learn.microsoft.com/en-us/dotnet/core/extensions/workers\">The main Microsoft documentation</a></li>\n<li><a href=\"https://learn.microsoft.com/en-us/aspnet/core/fundamentals/host/hosted-services\">Microsoft documentation about ASP.Net background tasks</a></li>\n<li><a href=\"https://www.hanselman.com/blog/dotnet-new-worker-windows-services-or-linux-systemd-services-in-net-core\">A blog from Scott Hanselman talking about Windows services and Linux deamons</a></li>\n<li><a href=\"https://youtu.be/elwx4Yhgs4Y?si=sHOgCIZGCc4vyDIm\">A video introduction from Mohamad Dbouk</a></li>\n</ul>\n<h1 id=\"source-code\" tabindex=\"-1\">Source code <a class=\"direct-link\" href=\"#source-code\">#</a></h1>\n<p>The source code for this article can be found in GitHub here:</p>\n<p><a href=\"https://github.com/seankearon/RebusBackgroundService\">https://github.com/seankearon/RebusBackgroundService</a></p>\n<h1 id=\"creating-the-solution\" tabindex=\"-1\">Creating the solution <a class=\"direct-link\" href=\"#creating-the-solution\">#</a></h1>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># Create the solution folder</span>\nmkdir RebusBackgroundService\ncd RebusBackgroundService\n\n<span class=\"token comment\"># Create the solution</span>\ndotnet new solution <span class=\"token operator\">--</span>name RebusBackgroundService\n\n<span class=\"token comment\"># Create the worker project and add it to the solution</span>\ndotnet new worker <span class=\"token operator\">--</span>name RebusWorkerService\ndotnet sln RebusBackgroundService<span class=\"token punctuation\">.</span>sln add <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>RebusWorkerService/RebusWorkerService<span class=\"token punctuation\">.</span>csproj</code></pre>\n<p>At this point you will have a basic .Net Worker.  Inside <code>Program.cs</code> you will see that it constructs a host and registers a worker service:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">RebusWorkerService</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> builder <span class=\"token operator\">=</span> Host<span class=\"token punctuation\">.</span><span class=\"token function\">CreateApplicationBuilder</span><span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nbuilder<span class=\"token punctuation\">.</span>Services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AddHostedService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> host <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span><span class=\"token function\">Build</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nhost<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>There is a <code>Worker</code> class derived from <code>BackgroundService</code> that is registered into the host and which writes to the log every second.</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">RebusWorkerService</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Worker</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">BackgroundService</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">ILogger<span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span> _logger<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ILogger<span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span> logger<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _logger <span class=\"token operator\">=</span> logger<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">ExecuteAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CancellationToken</span> stoppingToken<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stoppingToken<span class=\"token punctuation\">.</span>IsCancellationRequested<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>_logger<span class=\"token punctuation\">.</span><span class=\"token function\">IsEnabled</span><span class=\"token punctuation\">(</span>LogLevel<span class=\"token punctuation\">.</span>Information<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                _logger<span class=\"token punctuation\">.</span><span class=\"token function\">LogInformation</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Worker running at: {time}\"</span><span class=\"token punctuation\">,</span> DateTimeOffset<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n            <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> stoppingToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>You can run the project now, and it starts as a console app.  As the default logger is the console, you will see output similar to this:</p>\n<p><img src=\"basic-worker-logging.png\" alt=\"Basic worker logging to the console\"></p>\n<p>So, for our setup we need to include a couple more projects:</p>\n<ul>\n<li>A simple console that we can use to test our Rebus service.</li>\n<li>A shared library to hold our Rebus message types.</li>\n</ul>\n<p>To do that, run the following from the solution folder:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token comment\"># Create the shared message types project and add it to the solution</span>\ndotnet new classlib <span class=\"token operator\">--</span>name Messages\ndotnet sln RebusBackgroundService<span class=\"token punctuation\">.</span>sln add <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span>Messages/Messages<span class=\"token punctuation\">.</span>csproj\n\n<span class=\"token comment\"># Create the CLI project and add it to the solution</span>\ndotnet new console <span class=\"token operator\">--</span>name <span class=\"token function\">Cli</span>\ndotnet sln RebusBackgroundService<span class=\"token punctuation\">.</span>sln add <span class=\"token punctuation\">.</span><span class=\"token operator\">/</span><span class=\"token function\">Cli</span><span class=\"token operator\">/</span><span class=\"token function\">Cli</span><span class=\"token punctuation\">.</span>csproj</code></pre>\n<p>After that, your solution should look like this:</p>\n<p><img src=\"initial-solution.png\" alt=\"Initial solution structure\"></p>\n<h1 id=\"setting-up-the-rebus-bus\" tabindex=\"-1\">Setting up the Rebus bus <a class=\"direct-link\" href=\"#setting-up-the-rebus-bus\">#</a></h1>\n<p>We're focusing on hosting Rebus in a .Net Worker, so we're going to keep our Rebus implementation nice and simple.  We're going to:</p>\n<ul>\n<li>Process a message that just has some simple text for content.</li>\n<li>When the message is processed by Rebus, it will just write the message's text to the console.</li>\n</ul>\n<p>To make it easy to see the messages as they are processed by Rebus, we are going to:</p>\n<ul>\n<li>Use the file system as the transport mechanism for our messages.</li>\n<li>Use an audit queue so that we can easily inspect the processed messages.</li>\n</ul>\n<p>(If you want to go deeper into setting up Rebus, try <a href=\"https://seankearon.me/posts/2020/12/rebus-sagas-csharp/\">this article</a>.)</p>\n<p>So, let's get this set up so we can see Rebus doing something in our Worker Service!</p>\n<h2 id=\"define-the-message-type\" tabindex=\"-1\">Define the message type <a class=\"direct-link\" href=\"#define-the-message-type\">#</a></h2>\n<p>First, we define our simple message class that will carry the text content.</p>\n<p>Remove <code>Class1.cs</code> from the <code>Messages</code> project, add a new C# file named <code>SimpleText.cs</code> with the following content:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">namespace</span> <span class=\"token namespace\">Messages</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SimpleText</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Message <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<br/>\n<h2 id=\"define-the-rebus-bus\" tabindex=\"-1\">Define the Rebus bus <a class=\"direct-link\" href=\"#define-the-rebus-bus\">#</a></h2>\n<p>The plan here is to create a class to hole our Rebus <code>IBus</code> instance and have a single instance of this running inside our <code>BackgroundService</code>.</p>\n<h3 id=\"add-a-reference-to-rebus'-serviceprovider-package\" tabindex=\"-1\">Add a reference to Rebus' ServiceProvider package <a class=\"direct-link\" href=\"#add-a-reference-to-rebus'-serviceprovider-package\">#</a></h3>\n<p>We will add a reference to the <a href=\"https://www.nuget.org/packages/Rebus.ServiceProvider/\">Rebus NuGet package</a> to our Worker Service project. To do that, run the following from the folder of the <code>RebusWorkerService</code> project:</p>\n<p><code>dotnet add package Rebus.ServiceProvider</code></p>\n<p>This brings in everything we need from rebus for this simple example.  For production instances you likely will use other components such as <a href=\"https://www.nuget.org/packages/Rebus.AzureServiceBus/\">Rebus' Azure ServiceBus</a> etc.</p>\n<h3 id=\"create-a-rebus-bus-in-our-worker-service\" tabindex=\"-1\">Create a Rebus bus in our Worker Service <a class=\"direct-link\" href=\"#create-a-rebus-bus-in-our-worker-service\">#</a></h3>\n<p>We are going to create and run an instance of Rebus <code>IBus</code> directly inside our <code>Worker</code> service.  This follows the approach suggested by Mogens <a href=\"https://stackoverflow.com/questions/60629903/configuring-rebus-in-a-net-core-worker-service-or-a-console-app/60631521#60631521\">here</a>.</p>\n<p>To do that, we first create an <code>IServiceCollection</code> instance in our <code>Worker</code> service:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IServiceCollection</span> _services <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Then, we use the helpers from the <code>Rebus.ServiceProvider</code> to do our Rebus configuration, which we will do directly inside the <code>Worker</code> service's constructor:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token function\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    _services<span class=\"token punctuation\">.</span><span class=\"token function\">AddLogging</span><span class=\"token punctuation\">(</span>logging <span class=\"token operator\">=></span> logging<span class=\"token punctuation\">.</span><span class=\"token function\">AddConsole</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    _services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        rebus <span class=\"token operator\">=></span> rebus\n           <span class=\"token punctuation\">.</span>Logging  <span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">RetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">EnableMessageAuditing</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">auditQueue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AuditQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    _services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AutoRegisterHandlersFromAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>To keep things simple, we hard code the file system location we want Rebus' <code>FileSystemTransport</code> to use when processing messages.  We route failed messages to an error queue, and we also add message auditing just so that we can see all the messages we process when running this small example.  (You would probably not have auditing turned on production.)</p>\n<p>The last thing we need to do is to create and start a Rebus <code>IBus</code> instance like so:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">await</span> <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> provider <span class=\"token operator\">=</span> _services<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nprovider<span class=\"token punctuation\">.</span><span class=\"token function\">StartRebus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>Putting that all together makes our <code>Worker</code> class look like this:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Auditing<span class=\"token punctuation\">.</span>Messages</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Config</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Retry<span class=\"token punctuation\">.</span>Simple</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Transport<span class=\"token punctuation\">.</span>FileSystem</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">RebusWorkerService</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Worker</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">BackgroundService</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IServiceCollection</span> _services <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _services<span class=\"token punctuation\">.</span><span class=\"token function\">AddLogging</span><span class=\"token punctuation\">(</span>logging <span class=\"token operator\">=></span> logging<span class=\"token punctuation\">.</span><span class=\"token function\">AddConsole</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        _services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n            rebus <span class=\"token operator\">=></span> rebus\n               <span class=\"token punctuation\">.</span>Logging  <span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">RetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n               <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">EnableMessageAuditing</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">auditQueue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AuditQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        _services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AutoRegisterHandlersFromAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">ExecuteAsync</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CancellationToken</span> stoppingToken<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">using</span> <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> provider <span class=\"token operator\">=</span> _services<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        provider<span class=\"token punctuation\">.</span><span class=\"token function\">StartRebus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>stoppingToken<span class=\"token punctuation\">.</span>IsCancellationRequested<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span>TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> stoppingToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<br/>\n<h2 id=\"handle-the-messages\" tabindex=\"-1\">Handle the messages <a class=\"direct-link\" href=\"#handle-the-messages\">#</a></h2>\n<p>To give Rebus something to do, let's add a simple handler for our <code>SimpleText</code> messages.  The handler will just create a short delay, then log the message contents to the console.</p>\n<p>Add a file named <code>SimpleTextHandler.cs</code> to the <code>RebusServiceWorker</code> project.  The contents of which will be:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Messages</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Handlers</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">RebusWorkerService</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SimpleTextHandler</span><span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>SimpleText<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SimpleText</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Pretend we're doing some work!</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">.</span>Message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Remember that we already told Rebus to find and register all handlers from this project using the following line:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token function\">Worker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>snip<span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n    _services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AutoRegisterHandlersFromAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Worker<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>So, we now have a working bus - job done!</p>\n<h1 id=\"build-the-cli-to-send-our-messages\" tabindex=\"-1\">Build the CLI to send our messages <a class=\"direct-link\" href=\"#build-the-cli-to-send-our-messages\">#</a></h1>\n<p>Now, we just need a way to send messages to Rebus.  Let's update the <code>Cli</code> project we added earlier to build a quick and dirty console app to send our messages.</p>\n<p>Let's add the <code>Rebus.ServiceProvider</code> NuGet package to the project by running the following from the folder of the <code>Cli</code> project:</p>\n<p><code>dotnet add package Rebus.ServiceProvider</code></p>\n<p>Add the following code to the <code>Program.cs</code> file@</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">Messages</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>Extensions<span class=\"token punctuation\">.</span>DependencyInjection</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Bus</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Config</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Retry<span class=\"token punctuation\">.</span>Simple</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Routing<span class=\"token punctuation\">.</span>TypeBased</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Rebus<span class=\"token punctuation\">.</span>Transport<span class=\"token punctuation\">.</span>FileSystem</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> services <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nservices<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n    rebus <span class=\"token operator\">=></span> rebus\n       <span class=\"token punctuation\">.</span>Logging  <span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">.</span><span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SimpleText<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystemAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">RetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueName</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> provider <span class=\"token operator\">=</span> services<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nprovider<span class=\"token punctuation\">.</span><span class=\"token function\">StartRebus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\"><span class=\"token keyword\">var</span></span> bus <span class=\"token operator\">=</span> provider<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">GetRequiredService</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>IBus<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Enter the message text (type 'Q' to quit):\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> input <span class=\"token operator\">=</span> Console<span class=\"token punctuation\">.</span><span class=\"token function\">ReadLine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">?.</span><span class=\"token function\">ToUpper</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"Q\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SimpleText</span><span class=\"token punctuation\">{</span>Message <span class=\"token operator\">=</span> input<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nConsole<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Goodbye!\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n</code></pre>\n<br/>\n<h1 id=\"send-messages-to-rebus\" tabindex=\"-1\">Send messages to Rebus <a class=\"direct-link\" href=\"#send-messages-to-rebus\">#</a></h1>\n<p>Now we can run the <code>Cli</code> project, type a message, and press <code>Enter</code> to send the message to our Rebus message queue.  As we're using the <code>FileSystemTransport</code>, that will result in a file being saved into the <code>MainQueue</code> folder which corresponds to the name of our queue.</p>\n<p><img src=\"message-in-folder.png\" alt=\"Message in a folder\"></p>\n<p>The following line in our configuration was responsible for the routing:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">.</span><span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SimpleText<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre>\n<p>If you look into the message, you'll see the metadata that Rebus has wrapped around the message sent by our code.</p>\n<p><img src=\"message-content.png\" alt=\"Message content\"></p>\n<p>Our message content has been encoded into <code>Body</code>:</p>\n<p><img src=\"message-body-deserialised.png\" alt=\"Message body deserialsed\"></p>\n<h1 id=\"process-messages-in-our-worker-service\" tabindex=\"-1\">Process messages in our Worker Service <a class=\"direct-link\" href=\"#process-messages-in-our-worker-service\">#</a></h1>\n<p>Start the <code>RebusWorkerService</code> project and the message will be picked up and processed by our background worker, resulting in the message text being written to the console output.</p>\n<p>I had entered <code>&quot;This is the message we want to send&quot;</code> when I created the message in the CLI, which we can see below:</p>\n<p><img src=\"message-processed-console-output.png\" alt=\"Message output in the console\"></p>\n<p>As expected, Rebus has removed the message it processed, and we can see the audit queue contains what we have processed.</p>\n<p><img src=\"message-removed-after-processing.png\" alt=\"Message removed after processing\"></p>\n<p><img src=\"message-in-audit-queue.png\" alt=\"Message in the audit queue\"></p>\n",
      "date_published": "2024-04-19T00:00:00Z"
    },{
      "id": "https://seankearon.me/posts/2020/12/executor/",
      "url": "https://seankearon.me/posts/2020/12/executor/",
      "title": "Executor Changes How You Work",
      "content_html": "<p>It's always good when Scott Hanselman publishes a new <a href=\"https://hanselman.com/tools\">Ultimate Tools List</a>.  I love reading about new, cool utilities that folks use to help them work, and I'm using a lot of those already.  I'd like to shout out to a utility that I've been using for years and which, for me, fits into Scott's &quot;life and work-changing utilities&quot; category.</p>\n<p>That utility is <a href=\"http://www.executor.dk/\">Executor</a> from <a href=\"https://www.martinbresson.com/index.html\">Martin Bresson</a> and I completely rely on it in all of my daily development work.</p>\n<p>As a &quot;launcher&quot; app, Executor presents itself on a hot-key combination (I use <code>Alt + Z</code> for mine) and shows a little box that you can type into, command-line style.  Anyone who has used another launcher, such as <a href=\"https://docs.microsoft.com/en-us/windows/powertoys/run\">Windows PowerToys Run</a> or <a href=\"https://ueli.app/#/\">Ueli</a> that Scott mentions will be immediately familiar.</p>\n<p>Here's how Executor describes itself:</p>\n<blockquote>\n<p>Executor is a multi-purpose launcher sporting many optional customizable features and advanced setup. The program originated as I was sick of spending too much time searching for programs through my ever-growing windows start-menu, and eye-balling desktop trying to mouse locate whatever I wanted to launch. Also, I missed a tool that could ease and optimize my daily workflow. There was of course already programs like this available, but each had it's annoyance or missing features or too(!) geeky.</p>\n</blockquote>\n<h2 id=\"easy-to-customise\" tabindex=\"-1\">Easy to customise <a class=\"direct-link\" href=\"#easy-to-customise\">#</a></h2>\n<p>The capability that sets Executor apart from any of the other launchers that I have seen and tried over the years is that you can very easily customise it to add the specific functionality that you need in your daily workflow.  This capability comes from a bunch of parameters that are built into Executor.  The documentation for these are here:</p>\n<p><a href=\"http://www.1space.dk/executor/help.html#param\">http://www.1space.dk/executor/help.html#param</a></p>\n<p>Let's take a look at some of the things that I use these for.</p>\n<h2 id=\"focused-searching\" tabindex=\"-1\">Focused searching <a class=\"direct-link\" href=\"#focused-searching\">#</a></h2>\n<p>As a developer, I'm constantly looking for information on several topics.  Executor has search built-in and you can just type things like <code>google latest executor</code> or <code>wiki nirvana</code>.  Typing that and hitting <code>Enter</code> opens a browser displaying the search results for the term entered.</p>\n<p>The first stage into customising for me was realising that typing <code>google </code> was too many keystrokes for me.  I'm lazy, so I customised my web searches so that they ran when I typed just <code>?</code> plus my search term.</p>\n<p>That was great, but then when I'm working with a particular tech, such as writing a PowerShell script, and I found that I was constantly typing things like <code>? powershell copy file</code> or <code>? powershell copy file</code>.  So, for technologies that I am learning or work with, so I customised Executor to make these searches more specific.  Instead of <code>? powershell copy file</code> I replaced the <code>? powershell</code> with <code>ps</code> so that I now only have to type:</p>\n<blockquote>\n<p><code>ps copy file</code></p>\n</blockquote>\n<p>I have a whole bunch of these set up for things like PowerShell, Bootstrap 4, Bootstrap 3, F#, C#, etc.  It's particularly useful when you want to be more ?, such as searches related to &quot;<a href=\"http://ASP.Net\">ASP.Net</a> Core MVC&quot; or &quot;Microsoft SQL Server TSQL&quot;.</p>\n<p>It's very easy to set these up using the Keywords section in Executor's settings, as shown below.</p>\n<p><img src=\"keyword.png\" alt=\"Custom keyword\"></p>\n<p>I am just calling my browser and passing parameters using Executor's <code>$P$</code> parameter to capture what's typed after <code>ps</code> (but now I write this, I realise that I should probably be using <code>$U$</code> instead to URL encode that value!).  You can see that here:</p>\n<blockquote>\n<p><code>microsoft-edge:powershell $P$</code></p>\n</blockquote>\n<h2 id=\"running-scripts\" tabindex=\"-1\">Running scripts <a class=\"direct-link\" href=\"#running-scripts\">#</a></h2>\n<p>I also need to run scripts from time to time.  One example is when my public IP changes and I want to run a script to <a href=\"https://seankearon.me/posts/2020/11/using-powershell-to-set-sql-azure-firewall/\">set up a SQL Azure firewall rule</a> to allow access from my new IP address.  To do that, I just type <code>pir-azure-sql-ip</code> and watch the script set that up for me.  Here's how that is set up (no Executor parameters required for this one!):</p>\n<p><img src=\"run-script.png\" alt=\"Keyword that runs a script\"></p>\n<p>Under the hood, Executor stores your setup in an Ini file so you can keep all your customisations safe by simply backing up the file <code>%appdata%\\Roaming\\Executor\\executor.ini</code>.  You can see below the section that runs my SQL Azure script:</p>\n<pre><code>[W122]\nkeywords=pir-azure-sql-ip\ncommand=cmd.exe\npath=C:\\Users\\sean\\dev\\main\\powershell\nparam=/c powershell -NoProfile -ExecutionPolicy Bypass -Command &quot;&amp; '.\\set-sql-azure-ip-rule.ps1' %*;\n</code></pre>\n<h2 id=\"opening-specific-github-repositories\" tabindex=\"-1\">Opening specific GitHub repositories <a class=\"direct-link\" href=\"#opening-specific-github-repositories\">#</a></h2>\n<p>To open a particular GitHub repository I just type <code>gh repo-name</code> and my browser opens up on <code>https://github.com/seankearon/repo-name</code>.  That's easy to achieve using the <code>$U$</code> parameter:</p>\n<blockquote>\n<p><code>microsoft-edge:https://www.github.com/seankearon/$U$</code></p>\n</blockquote>\n<h2 id=\"clipboard-access-and-elevation\" tabindex=\"-1\">Clipboard access and elevation <a class=\"direct-link\" href=\"#clipboard-access-and-elevation\">#</a></h2>\n<p>I sometimes need to look up user GUID from a log file in one of my app's admin site.  To do that, I copy the GUID to the clipboard and type <code>admin-search</code> into Executor to open the admin site's search URL.  I set this up using the <code>$C$</code> parameter to access the contents of the Clipboard like so.</p>\n<pre><code>[W142]\nkeywords=admin-search\ncommand=microsoft-edge:https://myadminsite.azurewebsites.net/$C$\n</code></pre>\n<p>I also like to start my terminal elevated, just to avoid small frustrations like <a href=\"https://chocolatey.org/\">choco</a> telling me that it can't upgrade something.  To do that, I just added a command for <code>wt.exe</code> and set it to start elevated.  Simples!</p>\n<p><img src=\"windows-terminal.png\" alt=\"Starting Windows Terminal elevated\"></p>\n<p>These are some of the reasons why I definitely wouldn't want to work with without Executor on my machine.</p>\n",
      "date_published": "2020-12-27T00:00:00Z"
    },{
      "id": "https://seankearon.me/posts/2020/12/rebus-sagas-fsharp/",
      "url": "https://seankearon.me/posts/2020/12/rebus-sagas-fsharp/",
      "title": "Long-running business processes in F# with Rebus on Azure",
      "content_html": "<p>This post is part of the <a href=\"https://sergeytihon.com/2020/10/22/f-advent-calendar-in-english-2020/\">F# Advent Calendar 2020</a>.  There is an equivalent post but in C# <a href=\"https://seankearon.me/posts/2020/11/rebus-sagas-csharp/\">here</a>.</p>\n<p><strong>Note April 2024:</strong> The original code in this post is based on Rebus 6 and .Net 5.  The code in GitHub has now been updated to Rebus 8 and .Net 8.  Differences can be viewed in the <a href=\"https://github.com/seankearon/rebus-onboardingfs/pull/1\">here</a>.</p>\n<h1 id=\"introduction\" tabindex=\"-1\">Introduction <a class=\"direct-link\" href=\"#introduction\">#</a></h1>\n<p>This post talks about how to build a system that runs a long-running business process (aka workflow or &quot;saga&quot;) using a .Net library called <a href=\"https://github.com/rebus-org/Rebus\">Rebus</a>.</p>\n<p>Rebus is a library that makes it easy to build reliable, distributed systems.  We will show how to host our Rebus system in Azure App Services.  You will also be able to run it by pressing F5 in your IDE.</p>\n<p>We will be implementing a set of fictional, but quite typical business requirements around the onboarding of a new customer.</p>\n<p>So, let's get started!</p>\n<h1 id=\"introducing-rebus\" tabindex=\"-1\">Introducing Rebus <a class=\"direct-link\" href=\"#introducing-rebus\">#</a></h1>\n<p>Rebus is a distributed, asynchronous and durable .Net Service Bus that is a pleasure to use.  I like to think of Rebus as microservices without the <a href=\"https://en.wiktionary.org/wiki/faff\">faff</a>!  It's a .Net library uses messages to communicate between parts of your application and can do that reliably by using one of the various options for transporting and sharing those messages.  Rebus can be anywhere your application is (except on mobile and embedded devices afaik).</p>\n<p>I've been using Rebus for a long time now.  In my current gig, we are using Rebus in a national medicines optimisation healthcare system that serves around 50 million patients across the UK.  Rebus has helped us simplify and centralise a lot of complex, legacy back end processing and allow us to move the system from on-prem to the cloud.</p>\n<p>As a &quot;message-based architecture&quot;, Rebus is similar to other .Net Service Buses such as NServiceBus, Mass Transit or EasyNetQ.  Like these other service buses, Rebus uses a push model where it reacts to incoming messages.  This is distinct to streaming approaches such as used by Kafka, etc.</p>\n<p>Rebus is open source (MIT), completely free to use and has around 1.4K GitHub stars.  It is Danish software and the founder and primary maintainer is Mogens Heller Grabe (<a href=\"https://twitter.com/mookid8000\">@mookid8000</a>).  Mogens runs a company that provides consultancy, support and some rather excellent monitoring software for use with Rebus (more details here: <a href=\"https://rebus.fm/services/\">https://rebus.fm/services/</a>).</p>\n<p>Thanks to Mogens for kindly reviewing the content of this post.</p>\n<h1 id=\"what-good-things-does-rebus-bring-us%3F\" tabindex=\"-1\">What good things does Rebus bring us? <a class=\"direct-link\" href=\"#what-good-things-does-rebus-bring-us%3F\">#</a></h1>\n<p>Rebus brings high levels of reliability to your system.  Each message will either be processed or sent to an error queue so that you can fix the problem and replay it later.</p>\n<p>Rebus naturally breaks your system down into small chunks of functionality called handlers that are easy to write, reason about and test.  I find working with Rebus to be a very good developer experience (and the error messages are really useful too!).</p>\n<p>One or more handlers can respond to and process messages, which makes it very easy to extend your system without changing existing code.  Different handlers that process the same message do not need to be in the same application component.  This makes it easy to architect your application in a manner that supports your performance, scaling and security needs.</p>\n<p>Rebus can use various technologies to store messages that are being processed.  These are called <a href=\"https://github.com/rebus-org/Rebus/wiki/Transport\">message transports</a> and include RabbitMQ, Azure Service Bus, Amazon SQS and various databases.  There are also transports that use the file system or in-memory.  Rebus relies on the transport to provide durability and reliability, so you probably don't want to use the in-memory transport when you care about losing messages!  If Rebus can't process a message then it can retry that processing either in using a <a href=\"https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#customizing-retries\">simple approach</a>, using a <a href=\"https://github.com/rebus-org/Rebus/wiki/Back-off-strategy\">back-off strategy</a> and you can also add a <a href=\"https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#second-level-retries\">second layer of processing</a> for a more comprehensive approach to handling failures.</p>\n<p>Ultimately, if the message can't be processed for whatever reason, then Rebus will keep it for you in the part of the transport that you nominate as the error queue when you configure Rebus.  As well as the message, Rebus also stores the details of the failures in the message's headers so that you can easily see what went wrong and fix it.  When you've put the database server's plug back into the wall, or fixed the cause of the failure in some other way, you can move the message back to the processing queue so that processing can begin again!</p>\n<p>There are plenty of other good things in Rebus that we don't have time to talk about here, such as</p>\n<ul>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Data-bus\">Transporting larger data using the Data Bus</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Workers-and-parallelism\">Controlling the number of workers and parallelism</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Wire-level-format-of-messages\">Controlling how Rebus serialises messages</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Message-compression-and-encryption\">Compressing and encrypting the contents of messages</a></li>\n</ul>\n<p>As you'd expect, there is superb support for <a href=\"https://github.com/rebus-org/Rebus/wiki/Testing\">testing too</a>!</p>\n<p>Check out the official wiki here:</p>\n<p><a href=\"https://github.com/rebus-org/Rebus/wiki\">https://github.com/rebus-org/Rebus/wiki</a></p>\n<h1 id=\"overview-of-our-scenario\" tabindex=\"-1\">Overview of our scenario <a class=\"direct-link\" href=\"#overview-of-our-scenario\">#</a></h1>\n<p>We are going to jump into Rebus a little beyond the basics of request/reply or pub/sub and look at how to model long-running, durable workflows (aka sagas) in Rebus.  We are going to use Rebus to build an application that processes new customers for a hypothetical business and then host that in an Azure App Service.  You could also run the same code as a Windows Service if you wanted and it will run just the same in your IDE when you press F5 (or whatever you press to run your shizzle!).</p>\n<p>We're going to add a few requirements into our made-up business scenario, just so that we can showcase some of Rebus' features.  Let's take a look at the business requirements.</p>\n<p>We're going to model a business process that is under an <a href=\"https://en.wikipedia.org/wiki/Operational-level_agreement\">OLA</a> and which has compensating actions that must be taken if the requirements in the OLA are not met.</p>\n<p>The business wants us to build a system to handle the onboarding of new customers.  As well as functional requirements, the business also have operational requirements so that they can meet their <a href=\"https://en.wikipedia.org/wiki/Operational-level_agreement\">operational level agreements (OLA)</a>.  When a new customer is taken on, the business wants the following to happen:</p>\n<ul>\n<li>An account is to be created for the customer.</li>\n<li>A welcome email is to be sent to the customer after the account is created.</li>\n<li>A sales call is scheduled in the CRM after the account has been created.</li>\n</ul>\n<p>The business has an OLA in place that stipulates that new customers must be processed within a given time.  So that they can meet their OLA requirements, they want our workflow to complete within 10 minutes of the customer being taken on.  If the workflow does not complete within 10 minutes, the business wants the following to happen:</p>\n<ul>\n<li>Any placed sales call is to be cancelled.</li>\n<li>The service desk takes over the process.</li>\n</ul>\n<p>Great - we know what they want.  So, let's start building it!</p>\n<h1 id=\"our-architecture\" tabindex=\"-1\">Our architecture <a class=\"direct-link\" href=\"#our-architecture\">#</a></h1>\n<p>Our architecture is very simple.  This is what is looks like:</p>\n<p><img src=\"customer-onboarding-architecture.png\" alt=\"\"></p>\n<p>There is a web API that serves as an entry point to let us know about the new customer.  There is a back end processing system that does all our processing.  There is also a CRM and a customer database.</p>\n<p>We are going to build the entry point API and the back end processing system.  We are going to pretend that the CRM and the database exist.</p>\n<p>Rebus will be used in the web API and the back end processing system.</p>\n<h1 id=\"setting-up-the-projects\" tabindex=\"-1\">Setting up the projects <a class=\"direct-link\" href=\"#setting-up-the-projects\">#</a></h1>\n<p>We're going to be using .Net 5, and I'll be using JetBrains Rider, but you can use your IDE of choice!  We're going to build everything so that it runs on our local machines and then migrate it to the Cloud later.  You can find the code in GitHub here:</p>\n<p><a href=\"https://github.com/seankearon/rebus-onboardingfs.git\">https://github.com/seankearon/rebus-onboardingfs.git</a></p>\n<p>So that you can skip ahead, there are branches that have the outcomes of the stages as mentioned below.</p>\n<p>The basic setup is to create a project for our Web API and a Console App project for our back end processor.  We'll call these EntryPointAPI and OnboardingProcessor respectively.  We'll see later how to run this locally, in an Azure App Service or a Windows Service.</p>\n<p>Then we add the <a href=\"https://www.nuget.org/packages/Rebus\">Rebus</a> and <a href=\"https://www.nuget.org/packages/Rebus.ServiceProvider\">Rebus.ServiceProvider</a> NuGet packages to each project, giving us something like this:</p>\n<p><img src=\"1-basic-project-fs.png\" alt=\"\"></p>\n<p>This stage is available on the branch <em>1-basic-project-setup</em>.</p>\n<h1 id=\"defining-our-messages\" tabindex=\"-1\">Defining our messages <a class=\"direct-link\" href=\"#defining-our-messages\">#</a></h1>\n<p>So, now we have a couple of projects waiting for some code, we need to think about what we're going to build!  In a message-based system, a good place to start is designing your messages.</p>\n<p>In Rebus, you model your messages as <a href=\"https://en.wikipedia.org/wiki/Plain_old_CLR_object\">POCOs</a>.  Messages will be used by different parts of our system, so we'll put them into a shared assembly.  Messages should also be small and immutable.  (Rebus does allow mutating a message but, as processing is asynchronous, it's not a good idea as it can lead to unpredictable behaviour.  If you find you need to change the message state during processing then look at using another message to model the state changes.)</p>\n<h2 id=\"events-and-commands\" tabindex=\"-1\">Events and commands <a class=\"direct-link\" href=\"#events-and-commands\">#</a></h2>\n<p>Before we look at our requirements and start building our messages, let's take a moment to look at two types of messages.</p>\n<p>Messages split into two broad categories: events and commands.  These correspond to the general meaning of the words with an event being a general notification that something has occurred (i.e. in the past) and a command is a when you tell a component to do something.</p>\n<p>To send a command in Rebus you use either <code>IBus.Send()</code> or <code>IBus.SendLocal()</code> to send the message to a specific queue.  The difference between those calls is that with <code>IBus.Send()</code> you need to use Rebus' routing to tell Rebus where to send the message, but <code>IBus.SendLocal()</code> always sends the message to the current endpoint's queue.</p>\n<h2 id=\"our-first-set-of-messages\" tabindex=\"-1\">Our first set of messages <a class=\"direct-link\" href=\"#our-first-set-of-messages\">#</a></h2>\n<p>Let's leave the OLA requirements to one side for now and look at our main requirements.  These say that when a customer is onboarded that:</p>\n<ul>\n<li>An account is to be created for the customer.</li>\n<li>A welcome email is to be sent to the customer after the account is created.</li>\n<li>A sales call is scheduled in the CRM after the account has been created.</li>\n</ul>\n<p>So, if we were sitting in a room together and someone was telling us what to do, they'd probably say something like this:</p>\n<p>&quot;Create an account for Sean.&quot;<br>\n&quot;Account created for Sean.&quot;<br>\n&quot;Send a welcome email to Sean.&quot;<br>\n&quot;Schedule a sales call with Sean.&quot;<br>\n&quot;Welcome email sent to Sean&quot;<br>\n&quot;Sales call scheduled with to Sean&quot;</p>\n<p>Someone is listening and ticks off what has been done.  If the process doesn't finish in time then they tell everyone to stop.  Check if the sales call should be cancelled and tell the service desk to take over.</p>\n<p>So, that looks like three commands and an event to me!  As it's good for messages to be immutable, let's use F# records to implement our messages, which gives us:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardNewCustomer</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        Name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n        Email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">CreateCustomerAccount</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        Name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n        Email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">CustomerAccountCreated</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        Email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span>\n        CustomerId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">SendWelcomeEmail</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        CustomerId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">WelcomeEmailSent</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        CustomerId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">ScheduleSaleCall</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        CustomerId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">SaleCallScheduled</span> <span class=\"token operator\">=</span>\n    <span class=\"token punctuation\">{</span>\n        CustomerId<span class=\"token punctuation\">:</span> <span class=\"token class-name\">int</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<p>Generally, you will want your messages to contain as little information as possible.  After the customer has been created, we then use the ID of the customer.  We use the <code>CustomerAccountCreated</code> message to let us know what ID the new customer has been assigned.  We will see how that is used later.</p>\n<p>This stage is available on the branch <em>2-main-messages-added</em></p>\n<h1 id=\"creating-the-web-api-entry-point\" tabindex=\"-1\">Creating the web API entry point <a class=\"direct-link\" href=\"#creating-the-web-api-entry-point\">#</a></h1>\n<p>The next job is to make our web API tell the backend about any new customers.  We'll just add a simple route to allow posting of a name and email.</p>\n<blockquote>\n<p>POST /newcustomer?name=my name&amp;email=me@my.email</p>\n</blockquote>\n<p>When we receive such a <code>POST</code> request then we will start the onboarding process by sending a <code>CreateCustomerAccount</code> message to the bus and respond with a <code>200 OK</code>.</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">Route</span><span class=\"token annotation-content\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"newcustomer\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">HttpPost</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">NewCustomer</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span><span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>OnboardNewCustomer<span class=\"token punctuation\">.</span>For name email<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>To do this, we need to set up Rebus in our web API.  There are two basic modes of operation for Rebus &quot;out of the box&quot;: normal and one-way client.  The one-way client mode &quot;does what it says on the tin&quot; and allows you to send messages from a component.  In normal mode, Rebus can send and receive messages.  You can read more about those <a href=\"https://github.com/rebus-org/Rebus/wiki/Different-bus-modes\">here</a>.</p>\n<p>We are going to set up Rebus inside our .Net 5 web API and inject an instance of the Rebus <code>IBus</code> into our controller.  Remember, at this stage, we are just using the file system as our transport and will be adding Azure later.  In time-honoured fashion, let's use an extension method to configure and register an <code>IBus</code> instance and then inject that into our controller.</p>\n<p>In <code>Startup.cs</code> we will add one call to our configure services method:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\">    <span class=\"token keyword\">member</span> _<span class=\"token punctuation\">.</span><span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span>services<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IServiceCollection</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        services<span class=\"token punctuation\">.</span><span class=\"token function\">AddControllers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>        <span class=\"token operator\">|></span> ignore\n        services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>Lib<span class=\"token punctuation\">.</span>configure<span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore</code></pre>\n<p>In our controller we add a constructor parameter for the <code>IBus</code> so that it will be injected into the instance.  Our controller method can then send the message to the bus, making our controller class look like this:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">namespace</span> EntryPointAPI<span class=\"token punctuation\">.</span>Controllers\n\n<span class=\"token keyword\">open</span> Microsoft<span class=\"token punctuation\">.</span>AspNetCore<span class=\"token punctuation\">.</span>Mvc\n<span class=\"token keyword\">open</span> Rebus<span class=\"token punctuation\">.</span>Bus\n<span class=\"token keyword\">open</span> FSharp<span class=\"token punctuation\">.</span>Control<span class=\"token punctuation\">.</span>Tasks<span class=\"token punctuation\">.</span>V2<span class=\"token punctuation\">.</span>ContextInsensitive\n<span class=\"token keyword\">open</span> OnboardingMessages\n\n<span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">ApiController</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">CustomerController</span> <span class=\"token punctuation\">(</span>bus <span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">inherit</span> <span class=\"token class-name\">ControllerBase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> _bus <span class=\"token operator\">=</span> bus\n\n    <span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">Route</span><span class=\"token annotation-content\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"newcustomer\"</span><span class=\"token punctuation\">)</span></span><span class=\"token punctuation\">>]</span></span>\n    <span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">HttpPost</span><span class=\"token punctuation\">>]</span></span>\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">NewCustomer</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span><span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">:</span> <span class=\"token class-name\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>OnboardNewCustomer<span class=\"token punctuation\">.</span>For name email<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span></code></pre>\n<p><strong>Aside 1:</strong> I like to add static helpers to my records where it improves readability.  In the above controller, I can easily see that I'm onboarding a new customer.  YMMV!</p>\n<p><strong>Aside 2:</strong> We're using the task builder from the <a href=\"https://www.nuget.org/packages/TaskBuilder.fs\">TaskBuilder NuGet package</a> to allow our controller method to return a <code>System.Threading.Tasks.Task</code>.</p>\n<p>Pretty simple, right?  All that remains now is to look at the Rebus configuration in our <code>Lib.configure</code> function.  This looks like:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">module</span> Lib <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">open</span> Rebus<span class=\"token punctuation\">.</span>Config\n    <span class=\"token keyword\">open</span> OnboardingMessages\n    <span class=\"token keyword\">open</span> Rebus<span class=\"token punctuation\">.</span>Retry<span class=\"token punctuation\">.</span>Simple\n    <span class=\"token keyword\">open</span> Rebus<span class=\"token punctuation\">.</span>Routing<span class=\"token punctuation\">.</span>TypeBased\n    <span class=\"token keyword\">open</span> Rebus<span class=\"token punctuation\">.</span>Transport<span class=\"token punctuation\">.</span>FileSystem\n\n    <span class=\"token keyword\">let</span> configure <span class=\"token punctuation\">(</span>rebus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RebusConfigurer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n           rebus<span class=\"token punctuation\">.</span>Logging   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> l <span class=\"token operator\">-></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                                  <span class=\"token operator\">|></span> ignore <span class=\"token comment\">// A</span>\n           rebus<span class=\"token punctuation\">.</span>Routing   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> r <span class=\"token operator\">-></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Map<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore <span class=\"token comment\">// B</span>\n           rebus<span class=\"token punctuation\">.</span>Transport <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystemAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>             <span class=\"token operator\">|></span> ignore <span class=\"token comment\">// C</span>\n           rebus<span class=\"token punctuation\">.</span>Options   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span>errorQueueAddress <span class=\"token operator\">=</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>      <span class=\"token operator\">|></span> ignore <span class=\"token comment\">// D</span>\n           rebus</code></pre>\n<p>So, in our configuration we do the following:</p>\n<p><strong>A:</strong> We tell Rebus to log to the console.</p>\n<p><strong>B:</strong> We tell Rebus where to send the <code>OnboardNewCustomer</code> messages.  In Rebus, messages go to &quot;queues&quot;.</p>\n<p><strong>C:</strong> we tell Rebus to use the file system to transport messages, and we tell Rebus that we will only ever be sending messages.</p>\n<p><strong>D:</strong> we tell Rebus to retry any failures (the default is 5 times, but you can set that as you wish) and to send messages that are still failing log to the queue called &quot;ErrorQueue&quot;.</p>\n<p>This configuration will change a little later when we use Azure ServiceBus as our message transport.  But, we're now ready to start sending messages.  Woohoo!</p>\n<p>The code at this point is available in the branch <code>3-entry-point-api-working</code>.  Go and run that, crank up your favourite HTTP tool and send the following to your new API (don't forget to add the host!):</p>\n<blockquote>\n<p>POST /newcustomer?name=Sean&amp;email=sean@my.email</p>\n</blockquote>\n<p><strong>Aside:</strong> If you're using Rider, you can run the line above from  <a href=\"https://www.jetbrains.com/help/rider/Http_client_in__product__code_editor.html\">Rider's built-in HTTP client</a>.  How cool is that? :)</p>\n<p>Then you will see a file has appeared in <code>c:/rebus-advent/MainQueue</code>.  We can just open that up to see that a message in Rebus consists of a set of headers and a body:</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"rbs2-intent\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"p2p\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-msg-id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"323e07bb-4dd2-43b4-af5d-9c5749742cd7\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-senttime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2020-11-10T11:17:26.1492853+00:00\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-msg-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"OnboardingMessages.OnboardNewCustomer, OnboardingMessages\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-corr-id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"323e07bb-4dd2-43b4-af5d-9c5749742cd7\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-corr-seq\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-content-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json;charset=utf-8\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eyIkdHlwZSI6Ik9uYm9hcmRpbmdNZXNzYWdlcy5PbmJvYXJkTmV3Q3VzdG9tZXIsIE9uYm9hcmRpbmdNZXNzYWdlcyIsIk5hbWUiOiJTZWFuIiwiRW1haWwiOiJzZWFuQG15LmVtYWlsIn0=\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The body is Base64 encoded JSON that is our serialised message:</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"$type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"OnboardingMessages.OnboardNewCustomer, OnboardingMessages\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Sean\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sean@my.email\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"a-quick-review\" tabindex=\"-1\">A quick review <a class=\"direct-link\" href=\"#a-quick-review\">#</a></h1>\n<p>So, to add Rebus to our normal .Net Web API project we have:</p>\n<ul>\n<li>Defined our messages.</li>\n<li>Added around 4 lines of configuration.</li>\n<li>Registered Rebus into .Net 5's DI.</li>\n<li>Sent the message into our bus directly from our controller method.</li>\n</ul>\n<p>Because of the reliability and durability that Rebus' brings, any client that calls our <code>/newcustomer</code> API and receives a <code>200 OK</code> knows that the onboarding process has now started and that it will be processed as expected.</p>\n<p>That's a good start!  Let's move on to creating the back end of our system that is going to process the messages from the API.</p>\n<h1 id=\"creating-the-back-end\" tabindex=\"-1\">Creating the back end <a class=\"direct-link\" href=\"#creating-the-back-end\">#</a></h1>\n<p>The way we set up Rebus in the back end is going to be very similar to how we did that in the API.  There are some essential differences that we will focus on:</p>\n<ul>\n<li>The back end needs to send <em>and</em> receive messages.</li>\n<li>The back end will be performing a long-running, durable workflow/saga.</li>\n<li>We want to be able to host the back end in an Azure App Service, as well as run it locally (and, possibly, in a Windows Service).</li>\n</ul>\n<h2 id=\"configuring-rebus-for-send-and-receive\" tabindex=\"-1\">Configuring Rebus for send and receive <a class=\"direct-link\" href=\"#configuring-rebus-for-send-and-receive\">#</a></h2>\n<p>Next we are going to use a library called <a href=\"https://github.com/rebus-org/Topper\">Topper</a> form the creator of rebus, Mogens (here's <a href=\"https://rebus.fm/2019/01/29/generic-host/\">Mogens' blog</a> introducing Topper.  Under the hood, Topper uses the venerable <a href=\"http://topshelf-project.com/\">Topshelf library</a> and requires us to implement our back end as an <code>IDisposable</code> wrapper and run it inside a Console application project.</p>\n<p>I'm going to sprinkle in a little bit of <a href=\"https://github.com/serilog/serilog\">Serilog</a> too, just for fun.  Our entry point will look like the following:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">open</span> System\n<span class=\"token keyword\">open</span> OnboardingProcessor\n<span class=\"token keyword\">open</span> Serilog\n<span class=\"token keyword\">open</span> Topper\n\n<span class=\"token annotation\"><span class=\"token punctuation\">[&lt;</span><span class=\"token class-name\">EntryPoint</span><span class=\"token punctuation\">>]</span></span>\n<span class=\"token keyword\">let</span> main _ <span class=\"token operator\">=</span>\n    Log<span class=\"token punctuation\">.</span>Logger <span class=\"token operator\">&lt;-</span> <span class=\"token function\">LoggerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">.</span>WriteTo<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">.</span><span class=\"token function\">CreateLogger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">let</span> configuration <span class=\"token operator\">=</span> <span class=\"token function\">ServiceConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OurBackendBus\"</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">fun</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Backend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">IDisposable</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    ServiceHost<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token number\">0</span></code></pre>\n<p>That all we need to do to set up for running locally or in Azure.  We can also create and run it as a Windows Service just by calling the executable using the parameter <code>install</code> (use <code>uninstall</code> to remove the service).  Very cool!</p>\n<p>The rest of the magic all happens in our <code>Backend</code> class.  Let's take a look at that.</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Backend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mutable</span> provider<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ServiceProvider</span>  <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">let</span> <span class=\"token keyword\">mutable</span> bus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span>  <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token keyword\">do</span>\n        <span class=\"token keyword\">let</span> services <span class=\"token operator\">=</span> <span class=\"token function\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        services<span class=\"token punctuation\">.</span>AddRebus configureRebus <span class=\"token operator\">|></span> ignore\n        services<span class=\"token punctuation\">.</span>AutoRegisterHandlersFromAssemblyOf<span class=\"token operator\">&lt;</span>Backend<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n\n        provider <span class=\"token operator\">&lt;-</span> services<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        provider<span class=\"token punctuation\">.</span><span class=\"token function\">UseRebus</span><span class=\"token punctuation\">(</span>Action<span class=\"token operator\">&lt;</span>IBus<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> x <span class=\"token operator\">-></span> bus <span class=\"token operator\">&lt;-</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IDisposable</span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            printfn <span class=\"token string\">\"Disposing - tchau!\"</span>\n            <span class=\"token keyword\">if</span> bus <span class=\"token operator\">&lt;></span> <span class=\"token keyword\">null</span> <span class=\"token keyword\">then</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> provider <span class=\"token operator\">&lt;></span> <span class=\"token keyword\">null</span> <span class=\"token keyword\">then</span> provider<span class=\"token punctuation\">.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Bus <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> IBus <span class=\"token operator\">=</span> bus</code></pre>\n<p>Like before, we've put the configuration spell into a separate function, which looks like this:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> configureRebus <span class=\"token punctuation\">(</span>rebus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RebusConfigurer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    rebus<span class=\"token punctuation\">.</span>Logging       <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> l <span class=\"token operator\">-></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Serilog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                                            <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Routing       <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> r <span class=\"token operator\">-></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>MapAssemblyOf<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Transport     <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span>              <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Options       <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span>errorQueueAddress <span class=\"token operator\">=</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Sagas         <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> s <span class=\"token operator\">-></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">UseFilesystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent/sagas\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                               <span class=\"token operator\">|></span> ignore\n    rebus</code></pre>\n<p>This is very similar to the previous one, but we are not using the <code>*AsOneWayClient</code> flavours of the configuration methods.  We are going to be dealing with more than one message in our back end, so the routing maps all messages from the assembly to our <code>MainQueue</code>.  The file system transport is two-way and therefore needs to know which queue to work against - that's <code>MainQueue</code> again.  Lastly, we've got a new configuration item to set us up ready for our sagas later on.</p>\n<p>In the <code>Backend</code> ctor there is one new line that we haven't seen before now: <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;() |&gt; ignore</code>.  This tells Rebus to scan the assembly to find and register handlers, which in Rebus are types that will process messages.  You can now test that the lovely new backend is working by adding a handler for the <code>OnboardNewCustomer</code> message, as follows:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">DummyHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">:</span> <span class=\"token class-name\">OnboardNewCustomer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    failwith <span class=\"token string\">\"This is just a dummy handler!\"</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>You can see that we're using <code>TaskBuilder</code> in our handler here again.  This will return a <code>Task&lt;Unit&gt;</code> which we cast back to <code>Task</code> so that everybody is happy.</p>\n<p>If you have a message waiting in the queue from before, then this will be found and Rebus will pass it to the handler above and can break in your IDE to see that the data from our earlier message is passed into our handler.  If you don't have a message waiting, just use the API to send one.</p>\n<p><img src=\"fs-break-in-handler.png\" alt=\"\"></p>\n<p>You can also see the logging output in the console:</p>\n<p><img src=\"rebus-console-output.png\" alt=\"\"></p>\n<p>If you allow the program to run, you'll see in the console that Rebus will retry the message 5 times - getting our <code>NotImplementedException</code> each time, and then the message is moved to our <code>ErrorQueue</code>:</p>\n<p><img src=\"message-in-error-queue-filesystem.png\" alt=\"\"></p>\n<p>Just drag it back to the <code>MainQueue</code> to start processing again!</p>\n<p>You can find the code at this point on the branch <code>4-back-end-configuration</code>.</p>\n<p><strong>Aside:</strong>  Did you see what happened there?  Our system didn't stop working just because the back end component was down (okay, not even written yet!!).  The message stayed in the queue and waited until there was something to process it.  That's a nice example of how using Rebus increases the reliability of your system.</p>\n<h2 id=\"creating-the-saga\" tabindex=\"-1\">Creating the saga <a class=\"direct-link\" href=\"#creating-the-saga\">#</a></h2>\n<p>Okay, we're ready now to create our saga, the code that will run our workflow.  Rebus models sagas by implementing two connected classes.  One that holds any state that changes throughout the workflow, and one that is responsible for coordinating the work done throughout the long-running process.  This is what the basic structures look like:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ISagaData</span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">&lt;-</span> value\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision <span class=\"token operator\">&lt;-</span> value\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Id <span class=\"token operator\">=</span> Guid<span class=\"token punctuation\">.</span>Empty <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Revision <span class=\"token operator\">=</span> <span class=\"token number\">0</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardingSaga</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">inherit</span> <span class=\"token class-name\">Saga</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">override</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ICorrelationConfig</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">OnboardNewCustomer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p><strong>Aside:</strong> Why are we messing around with the getters and setters for the <code>Id</code> and <code>Revision</code> properties in <code>OnboardingSagaData</code>?  Well, by default, Rebus serialises to JSON (although you can choose another format, such as Protobuf and other (see <a href=\"https://github.com/rebus-org/Rebus/wiki/Serialization\">here</a> for more details)).   In F#, all interfaces are explicit and so, to ensure that the JSON serialiser picks up the saga data's <code>Id</code> and <code>Revision</code> properties, we need to add some additional code so that we can see those properties from the interface and from a plain instance.</p>\n<p>The <code>OnboardingSagaData</code> class needs the <code>Id</code> and <code>Revision</code> properties so that Rebus can control concurrent access to the saga's state for us.</p>\n<p>Each time a customer is onboarded, there will be a saga instance that is responsible for controlling the onboarding workflow for that customer.  The <code>CorrelateMessages</code> method in the  <code>OnboardingSaga</code> class is used by Rebus to find the saga instance that relates to a particular message.</p>\n<p>We tell Rebus when to start a new saga by adding the interface <code>IAmInitiatedBy&lt;OnboardNewCustomer&gt;</code>.  Soon, we will add other messages that will be processed by the saga by using the <code>IHandleMessages&lt;T&gt;</code> interface.</p>\n<p>Let's push on and see how this is implemented for the full workflow (except the OLA requirements).</p>\n<p>We need to track what's going on in our workflow.  We do that by adding state to the <code>ISagaData</code> implementation.  We're going to keep hold of the name, email and the new account id and we also want to track what actions have happened.   I've added the <code>IsComplete</code> helper property that we'll use in the saga.</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ISagaData</span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">&lt;-</span> value\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision <span class=\"token operator\">&lt;-</span> value\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Id       <span class=\"token operator\">=</span> Guid<span class=\"token punctuation\">.</span>Empty <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Revision <span class=\"token operator\">=</span> <span class=\"token number\">0</span>          <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> CustomerName  <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> CustomerEmail <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> AccountId     <span class=\"token operator\">=</span> <span class=\"token number\">0</span>  <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> AccountCreated     <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> WelcomeEmailSent   <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> SalesCallScheduled <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Completed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>AccountCreated <span class=\"token operator\">&amp;&amp;</span> this<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">&amp;&amp;</span> this<span class=\"token punctuation\">.</span>SalesCallScheduled</code></pre>\n<p>We update the state from inside the handlers in our saga (Rebus makes the saga's data available via the instance's <code>Data</code> property).  For example, when we get a confirmation that the welcome email has been sent:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">:</span> <span class=\"token class-name\">WelcomeEmailSent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n            this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">true</span><span class=\"token punctuation\">;</span>\n            this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>At the exit of each handler method, we call <code>TryComplete()</code>.  This method checks to see that we've done everything we want to do and, if so, we call the Rebus' <code>MarkAsComplete()</code> method.   Rebus will then remove clean up and remove the saga's state for us.  We call this every time as Rebus, being distributed and asynchronous, may have finished up the saga in the blink of an eye!  (Okay, we probably don't need to call it at the end of the initiating method, but I like to do that for consistency!)  This is our <code>TryComplete()</code> method:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">if</span> this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span><span class=\"token function\">Completed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">MarkAsComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>Rebus needs to know how to find the saga state for our particular workflow, and we have updated the <code>CorrelateMessages</code> method with the necessary code to let Rebus do just that:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">override</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ICorrelationConfig</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span>     <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">,</span>     obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>Email     <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> CustomerEmail<span class=\"token punctuation\">)</span>\n    config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>CustomerAccountCreated<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">,</span> obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>Email     <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> CustomerEmail<span class=\"token punctuation\">)</span>\n    config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token operator\">></span>       <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">,</span>       obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> AccountId<span class=\"token punctuation\">)</span>\n    config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>SalesCallScheduled<span class=\"token operator\">></span>     <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">,</span>     obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> AccountId<span class=\"token punctuation\">)</span></code></pre>\n<p>The configuration allows you to correlate a property value in each message handled by the saga with a value in the saga's state.  You just need to make sure Rebus can uniquely identify the saga from these values and then sit back and let Rebus do all the finding for you!  We're using the email and the account ID when it's known.  Note that you need to supply a correlation for Rebus to identify all messages to which the saga responds, including the message that initiates the saga.</p>\n<p>In the above, we're using F# 5#s <code>nameof</code> to get the names of the properties for our correlation:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> AccountId <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token function\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    nameof x<span class=\"token punctuation\">.</span>AccountId</code></pre>\n<p>There is a little boilerplate involved here, the reasons being outlined [here](// <a href=\"https://github.com/fsharp/fslang-design/blob/master/preview/FS-1003-nameof-operator.md#names-of-instance-members\">https://github.com/fsharp/fslang-design/blob/master/preview/FS-1003-nameof-operator.md#names-of-instance-members</a>).  Also, to get <code>nameof</code> working, I had to set <code>&lt;LangVersion&gt;preview&lt;/LangVersion&gt;</code> in the project file.</p>\n<p>All that remains is to do some work inside the saga.  Generally, I like to keep my sagas pretty &quot;slim&quot; and make them responsible for coordinating the flow of work.  I tend to pass off work to other handlers by sending messages out from the saga.  Here's how that looks in the saga's initiating handler:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">OnboardNewCustomer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> this<span class=\"token punctuation\">.</span>IsNew <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n            this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>CustomerName  <span class=\"token operator\">&lt;-</span> m<span class=\"token punctuation\">.</span>Name\n            this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>CustomerEmail <span class=\"token operator\">&lt;-</span> m<span class=\"token punctuation\">.</span>Email\n\n            <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>CreateCustomerAccount<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>Name m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">)</span>\n\n            this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>In the first line, we check that the saga hasn't already been created by another process and abandon if so.  Then, after setting some state, we use the Rebus <code>IBus</code> instance has been injected into our saga to send a command message to create an account for the customer details we have been given.</p>\n<p><code>do! bus.Send(CreateCustomerAccount.For m.Name m.Email)</code></p>\n<p>As our requirements say that everything else should happen <em>after</em> the account has been created, that's all we need to do there.</p>\n<p>The full code looks like this:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">ISagaData</span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Id <span class=\"token operator\">&lt;-</span> value\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">with</span> get <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision\n            <span class=\"token keyword\">and</span> set <span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>Revision <span class=\"token operator\">&lt;-</span> value\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Id       <span class=\"token operator\">=</span> Guid<span class=\"token punctuation\">.</span>Empty <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> Revision <span class=\"token operator\">=</span> <span class=\"token number\">0</span>          <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> CustomerName  <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> CustomerEmail <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> AccountId     <span class=\"token operator\">=</span> <span class=\"token number\">0</span>  <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> AccountCreated     <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> WelcomeEmailSent   <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n    <span class=\"token keyword\">member</span> <span class=\"token keyword\">val</span> SalesCallScheduled <span class=\"token operator\">=</span> <span class=\"token keyword\">false</span> <span class=\"token keyword\">with</span> get<span class=\"token punctuation\">,</span> set\n\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Completed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> this<span class=\"token punctuation\">.</span>AccountCreated <span class=\"token operator\">&amp;&amp;</span> this<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">&amp;&amp;</span> this<span class=\"token punctuation\">.</span>SalesCallScheduled\n\n<span class=\"token keyword\">let</span> CustomerEmail <span class=\"token operator\">=</span>\n    <span class=\"token comment\">// https://github.com/fsharp/fslang-design/blob/master/preview/FS-1003-nameof-operator.md#names-of-instance-membersabove</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token function\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    nameof x<span class=\"token punctuation\">.</span>CustomerEmail\n\n<span class=\"token keyword\">let</span> AccountId <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> x <span class=\"token operator\">=</span> <span class=\"token function\">OnboardingSagaData</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    nameof x<span class=\"token punctuation\">.</span>AccountId\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">OnboardingSaga</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">inherit</span> <span class=\"token class-name\">Saga</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> bus <span class=\"token operator\">=</span> b\n\n    <span class=\"token keyword\">override</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ICorrelationConfig</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span>     <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">,</span>     obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>Email     <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> CustomerEmail<span class=\"token punctuation\">)</span>\n        config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>CustomerAccountCreated<span class=\"token operator\">></span> <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">,</span> obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>Email     <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> CustomerEmail<span class=\"token punctuation\">)</span>\n        config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token operator\">></span>       <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">,</span>       obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> AccountId<span class=\"token punctuation\">)</span>\n        config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>SalesCallScheduled<span class=\"token operator\">></span>     <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">,</span>     obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> AccountId<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token keyword\">if</span> this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span><span class=\"token function\">Completed</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">then</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">MarkAsComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\">// This is to allow access to IsNew from inside the interface sections below.</span>\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span>IsNew <span class=\"token operator\">=</span> <span class=\"token keyword\">base</span><span class=\"token punctuation\">.</span>IsNew\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">OnboardNewCustomer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> this<span class=\"token punctuation\">.</span>IsNew <span class=\"token keyword\">then</span> <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>CustomerName  <span class=\"token operator\">&lt;-</span> m<span class=\"token punctuation\">.</span>Name\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>CustomerEmail <span class=\"token operator\">&lt;-</span> m<span class=\"token punctuation\">.</span>Email\n\n                <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>CreateCustomerAccount<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>Name m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">)</span>\n\n                this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>CustomerAccountCreated<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CustomerAccountCreated</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>AccountId      <span class=\"token operator\">&lt;-</span> m<span class=\"token punctuation\">.</span>AccountId\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>AccountCreated <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">true</span>\n\n                <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span> SendWelcomeEmail<span class=\"token punctuation\">.</span>For  m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n                <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span> ScheduleSalesCall<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n\n                this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>WelcomeEmailSent<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">:</span> <span class=\"token class-name\">WelcomeEmailSent</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">true</span>\n                this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>SalesCallScheduled<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>_<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SalesCallScheduled</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n                this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>SalesCallScheduled <span class=\"token operator\">&lt;-</span> <span class=\"token keyword\">true</span>\n                this<span class=\"token punctuation\">.</span><span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>The code at this stage is available in the branch <code>5-saga-receives-messages</code>.</p>\n<p>If you check that out, run it and start the saga by posting to our API, then the message will fail and be placed in the error queue after be retried only once.  If you open up the message, you'll see something like this:</p>\n<p><img src=\"failed-message-with-error-in-header.png\" alt=\"\"></p>\n<p>Look inside the <code>rbs2-error-details</code> header and you will see that Rebus has stored the exception details in there for use.  They tell us this:</p>\n<pre><code>Message with ID db52a43d-a6bc-4a9d-a6c3-3d4a324fcaba\nand type OnboardingMessages.CreateCustomerAccount, OnboardingMessages\ncould not be dispatched to any handlers\n(and will not be retried under the default fail-fast settings)\n</code></pre>\n<p>This lovely, helpful error shows what Rebus puts messages onto the error queue if it cannot find any handlers to process it.  The &quot;fail-fast&quot; part is Rebus' built-in mechanism to skip retries when you are sure there is no point.</p>\n<h2 id=\"creating-the-remaining-handlers\" tabindex=\"-1\">Creating the remaining handlers <a class=\"direct-link\" href=\"#creating-the-remaining-handlers\">#</a></h2>\n<p>In a real-world application, you might choose to create another Rebus endpoint for one or more of the handlers we are going to create.  This could be because you want to deploy it separately for performance or other reasons.  Rebus makes it easy to structure your application how you want.  For us, we're going to put them all into the single endpoint - that's fine too! :)</p>\n<p>We need handlers that do the following:</p>\n<ul>\n<li>Create a customer account.</li>\n<li>Send a welcome email.</li>\n<li>Schedule a sales call.</li>\n</ul>\n<p>As we saw briefly above with our <code>DummyHandler</code>, a handler is just a class that implements the <code>IHandleMessages&lt;T&gt;</code> interface.  So, we need the following handlers:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">CreateCustomerAccountHandler</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> bus <span class=\"token operator\">=</span> b\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>CreateCustomerAccount<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CreateCustomerAccount</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span>CustomerAccountCreated<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>Email <span class=\"token punctuation\">(</span><span class=\"token function\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">SendWelcomeEmailHandler</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> bus <span class=\"token operator\">=</span> b\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>SendWelcomeEmail<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SendWelcomeEmail</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span>WelcomeEmailSent<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">ScheduleSalesCallHandler</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> bus <span class=\"token operator\">=</span> b\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>ScheduleSalesCall<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ScheduleSalesCall</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span>SalesCallScheduled<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>The fact that we included the line <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;()</code> in our Rebus setup means that we can put those handlers anywhere in our back end project.  Rebus will find them and set them up so that they are ready to use.</p>\n<p>You will notice that each handler notifies the saga that it was completed, sometimes passing back new information - such as the account ID.  It's perfectly possible to use the <code>IBus.Send*()</code> methods to do that.  But, I'm using  <code>IBus.Reply()</code> which replies to the Rebus endpoint/queue that the message came from.  That is a nice way to avoid having to think about whether I've configured the routing for that message!</p>\n<p>One of the joys of developing against the file system transport is that you can easily look into what Rebus is doing.  Just put a breakpoint in one of your handlers, use the API to start the onboarding process and you'll see the messages and saga state being updated on disk as you step through.</p>\n<p><img src=\"saga-in-action-filesystem.png\" alt=\"\"></p>\n<p>Congratulations!  If you've followed this far, you now have a long-running, durable workflow implemented in Rebus!</p>\n<p>You can get this code at this point from the branch <code>6-saga-processes-messages</code>.  I've added some logging to that so that you can watch things happening from the console too, so you should see something like this:</p>\n<p><img src=\"saga-logging-output.png\" alt=\"\"></p>\n<p><strong>Aside:</strong> There are two versions of this post - one using C# and one using F#.  Just for fun, why not try running the API from the <a href=\"https://github.com/seankearon/rebus-onboardingcs\">C# project</a> and the backend from the <a href=\"https://github.com/seankearon/rebus-onboardingfs\">F# project</a>?  As long as you're using the same transport (at this stage that's a file system in <code>c:\\rebus-advent</code>) then everything will work just fine.  How lovely is that? :)</p>\n<h2 id=\"adding-ola-support\" tabindex=\"-1\">Adding OLA support <a class=\"direct-link\" href=\"#adding-ola-support\">#</a></h2>\n<p>Okay, so that's most of our requirements covered.  We only have the OLA to add.  The requirement was that if the workflow does not complete within 10 minutes, the business want the following to happen:</p>\n<ul>\n<li>Any placed sales call is to be cancelled.</li>\n<li>The service desk takes over the process.</li>\n</ul>\n<p>To implement this, we're going to use a cool Rebus feature: deferred messages (which are talked about in the <a href=\"https://github.com/rebus-org/Rebus/wiki/Timeout-Manager\">timeout manager section</a> of the Rebus wiki).  Using this feature we can send ourselves a message that will be received at a time in the future.  If that message is received before the saga completes then we know that our time is up!  We send it like this:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">do</span><span class=\"token operator\">!</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Defer</span><span class=\"token punctuation\">(</span>TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">OnboardingOlaBreached</span> <span class=\"token punctuation\">{</span>SagaId <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n</code></pre>\n<p>When we get that, we just handle it like any other message.  Here's the handler to meet our OLA breach requirements:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">interface</span> <span class=\"token class-name\">IAmInitiatedBy</span><span class=\"token operator\">&lt;</span>OnboardingOlaBreached<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n    <span class=\"token keyword\">member</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">OnboardingOlaBreached</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n        <span class=\"token computation-expression keyword\">task</span> <span class=\"token punctuation\">{</span>\n            Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span>$<span class=\"token string\">\"ONBOARDING OLA BREACH PENDING FOR for saga {m.SagaId}.\"</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>CancelSalesCall<span class=\"token punctuation\">.</span>For this<span class=\"token punctuation\">.</span>Data<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span>NotifyServiceDesk<span class=\"token punctuation\">.</span>With $<span class=\"token string\">\"Customer onboarding OLA breach pending for new customer {this.Data.CustomerName} with email {this.Data.CustomerEmail}.\"</span><span class=\"token punctuation\">)</span>\n\n            Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span>$<span class=\"token string\">\"Abandoning saga {this.Data.Id}.\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            this<span class=\"token punctuation\">.</span><span class=\"token function\">MarkComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n</code></pre>\n<p><strong>Aside:</strong> so that the code in this interface section could access the <code>Saga.MarkAsComplete()</code>, I added a <code>MarkComplete()</code> member: <code>member this.MarkComplete() = base.MarkAsComplete()</code>.  There is probably a cleaner syntax somewhere!</p>\n<p>We send a message to cancel the sales call and then send another message to notify the service desk that bad things are about to happen!  After that, we call <code>MarkAsComplete()</code> to close the saga.</p>\n<p>Don't forget that we need to set up a correlation for our timeout message (<code>SagaId</code> string at the end is implemented similar to before):</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">override</span> this<span class=\"token punctuation\">.</span><span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">ICorrelationConfig</span><span class=\"token operator\">&lt;</span>OnboardingSagaData<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token comment\">// snip</span>\n    config<span class=\"token punctuation\">.</span>Correlate<span class=\"token operator\">&lt;</span>OnboardingOlaBreached<span class=\"token operator\">></span>  <span class=\"token punctuation\">(</span>Func<span class=\"token operator\">&lt;</span>OnboardingOlaBreached<span class=\"token punctuation\">,</span>  obj<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> m <span class=\"token operator\">-></span> m<span class=\"token punctuation\">.</span>SagaId    <span class=\"token operator\">:></span> <span class=\"token class-name\">obj</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> SagaId<span class=\"token punctuation\">)</span></code></pre>\n<p>We need to add a couple of handlers that will respond to our new fire-and-forget messages.  As these are not responding, they are simpler creatures:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">CancelSalesCallHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>CancelSalesCall<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CancelSalesCall</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token comment\">// Cancellation should allow for the call not having been placed as yet.</span>\n                    Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span>$<span class=\"token string\">\"Cancelling sales call for account {m.AccountId}.\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span>\n\n<span class=\"token keyword\">type</span> <span class=\"token class-name\">NotifyServiceDeskHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>NotifyServiceDesk<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">NotifyServiceDesk</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span>$<span class=\"token string\">\"Notifying the service desk that: {m.Message}.\"</span><span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>Lastly, we need to update the configuration spell to tell Rebus where to store timeouts.  We're going to store those in the file system for now:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> configureRebus <span class=\"token punctuation\">(</span>rebus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RebusConfigurer</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token comment\">// snip</span>\n    rebus<span class=\"token punctuation\">.</span>Timeouts <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> s <span class=\"token operator\">-></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent/timeouts\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n    rebus</code></pre>\n<p>That's all we need to meet the remaining requirements around the OLA and compensating actions.  In the code, we hard wired a 5-second timeout, so we can easily see the timeout in action by increasing the pretend delay in one of our handlers.</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">SendWelcomeEmailHandler</span><span class=\"token punctuation\">(</span>b<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IBus</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> bus <span class=\"token operator\">=</span> b\n\n    <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IHandleMessages</span><span class=\"token operator\">&lt;</span>SendWelcomeEmail<span class=\"token operator\">></span> <span class=\"token keyword\">with</span>\n        <span class=\"token keyword\">member</span> x<span class=\"token punctuation\">.</span><span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span>m<span class=\"token punctuation\">:</span> <span class=\"token class-name\">SendWelcomeEmail</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n            <span class=\"token computation-expression keyword\">task</span>\n                <span class=\"token punctuation\">{</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// This delay will breach our OLA rules!</span>\n                    <span class=\"token keyword\">do</span><span class=\"token operator\">!</span> bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span>WelcomeEmailSent<span class=\"token punctuation\">.</span>For m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span> <span class=\"token operator\">:></span> <span class=\"token class-name\">Task</span></code></pre>\n<p>Now, when we run the saga we will see the delay causing the OLA to become breached and the compensating actions taking over.</p>\n<p><img src=\"saga-logging-output-breached-ola.png\" alt=\"\"></p>\n<p>The code at this point is in the branch <code>7-ola-and-compensating-actions</code>.</p>\n<h1 id=\"migrating-to-the-cloud\" tabindex=\"-1\">Migrating to the Cloud <a class=\"direct-link\" href=\"#migrating-to-the-cloud\">#</a></h1>\n<p>What we have at this point will run in the IDE and can easily be installed as a Windows Service, as mentioned earlier.  All that remains now is to show how easy it is to migrate this to the cloud and run it in an Azure App Service.</p>\n<p>As we do this, you'll notice that all we change is the configuration and the functionality remains the same.  That's pretty awesome!  (Okay, sure, I've added some code to get the .Net <code>IConfiguration</code>, but that doesn't count. :) )</p>\n<p>We have two App Services that will host our entry point API and the back end processing system.  Instead of the file system, we will be using Azure Service Bus for our message transport and a SQL Azure database to store our saga state.</p>\n<p><img src=\"azure-architecture.png\" alt=\"\"></p>\n<p>As you know, we're using  <a href=\"https://github.com/rebus-org/Topper\">Topper</a> so that we can easily run our Rebus back end in the Azure App Service as continuous Web Job.  This means we need to have the App Service configured as <em>always on</em>.  We need to create a database for Rebus to use, but we're Rebus will create the tables if they don't already exist.  The same is true for the queues in our Azure Service Bus.  We need to change our configuration spells a little so that we can use these Azure resources.</p>\n<p><strong>Aside:</strong> In my production systems, I like to control the configuration based on a value in <code>appsettings.json</code>.  That means I always have my local file system transport set up and ready for any debugging I might want to do locally.</p>\n<p>We need to add the <a href=\"https://www.nuget.org/packages/Rebus.AzureServiceBus\">Rebus.AzureServiceBus NuGet</a> to our API and back end projects, and the <a href=\"https://www.nuget.org/packages/Rebus.SqlServer\">Rebus.SqlServer</a> to our back end project.  I'm using a basic SQL Azure database that costs 3.72 per month.  That should be adequate until start onboarding a lot of customers!</p>\n<p><strong>Aside:</strong> To avoid making our connections strings visible in our code, we're going to use .Net 5's built-in <a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0&amp;tabs=windows\">secret management</a>.  You could also just store those in your <code>appsettings.json</code> while testing the code and not check them in!</p>\n<p>You can access your Azure Service Bus connection string from the <strong>Shared access policies</strong> in the portal:</p>\n<p><img src=\"azure-service-bus-connection-string.png\" alt=\"\"></p>\n<p><strong>Tip:</strong> you can set your user secrets from the command line in the project folder: <code>dotnet user-secrets set &quot;ConnectionStrings:MsSqlConnectionString&quot; &quot;you connection string&quot;</code>.</p>\n<p>Here is the adjusted configuration spell for the back end:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> configureRebus <span class=\"token punctuation\">(</span>rebus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RebusConfigurer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IConfiguration</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> asbConnection <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AzureServiceBusConnectionString\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">let</span> sqlConnection <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MsSqlConnectionString\"</span><span class=\"token punctuation\">)</span>\n\n    rebus<span class=\"token punctuation\">.</span>Logging   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> l <span class=\"token operator\">-></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Serilog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                                                             <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Routing   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> r <span class=\"token operator\">-></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>MapAssemblyOf<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span>                  <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Transport <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseAzureServiceBus</span><span class=\"token punctuation\">(</span>asbConnection<span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AutomaticallyRenewPeekLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Options   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span>errorQueueAddress <span class=\"token operator\">=</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                 <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Options   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">EnableMessageAuditing</span><span class=\"token punctuation\">(</span>auditQueue <span class=\"token operator\">=</span> <span class=\"token string\">\"AuditQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                      <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Sagas     <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> s <span class=\"token operator\">-></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">StoreInSqlServer</span><span class=\"token punctuation\">(</span>sqlConnection<span class=\"token punctuation\">,</span> <span class=\"token string\">\"Sagas\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SagaIndexes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                               <span class=\"token operator\">|></span> ignore\n    rebus</code></pre>\n<p>You can see that the <code>.Transport</code> has changed to use Azure Service Bus (and that we allow Rebus to automatically renew peek locks on our behalf) and that the <code>.Sagas</code> configuration now uses SQL Server.  If you're paying close attention, you might have noticed that there is no longer an item to configure timeout storage.  That is because Rebus is using native behaviour in Azure Service Bus to achieve that (as it does with subscription storage, which is beyond the scope of this article). Nice!</p>\n<p>Just so we can see what's happened, we've turned on message auditing using <code>.EnableMessageAuditing(...)</code>.  Rebus will now put a copy of every processed message into the queue we nominate.</p>\n<p>The configuration spell for the API is adjusted similarly:</p>\n<pre class=\"language-fsharp\"><code class=\"language-fsharp\"><span class=\"token keyword\">let</span> configure <span class=\"token punctuation\">(</span>rebus<span class=\"token punctuation\">:</span> <span class=\"token class-name\">RebusConfigurer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">:</span> <span class=\"token class-name\">IConfiguration</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span>\n    <span class=\"token keyword\">let</span> asbConnection <span class=\"token operator\">=</span> config<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AzureServiceBusConnectionString\"</span><span class=\"token punctuation\">)</span>\n    rebus<span class=\"token punctuation\">.</span>Logging   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> l <span class=\"token operator\">-></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                                  <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Routing   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> r <span class=\"token operator\">-></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>Map<span class=\"token operator\">&lt;</span>OnboardNewCustomer<span class=\"token operator\">></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore<span class=\"token punctuation\">)</span> <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Transport <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystemAsOneWayClient</span><span class=\"token punctuation\">(</span>asbConnection<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                 <span class=\"token operator\">|></span> ignore\n    rebus<span class=\"token punctuation\">.</span>Options   <span class=\"token punctuation\">(</span><span class=\"token keyword\">fun</span> t <span class=\"token operator\">-></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span>errorQueueAddress <span class=\"token operator\">=</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>      <span class=\"token operator\">|></span> ignore\n    rebus</code></pre>\n<p><strong>Note:</strong> Make sure that you update the <a href=\"https://www.nuget.org/packages/Microsoft.Azure.ServiceBus\">Microsoft.Azure.ServiceBus NuGet</a> package to 5.0.0 or above or you might see an error like this when sending messages from the API:</p>\n<p><code>Rebus.Exceptions.RebusApplicationException: Could not send to queue 'MainQueue' ---&gt; System.InvalidOperationException: Operation is not valid due to the current state of the object.</code></p>\n<p>So, we can now run locally just the same as we before, but our messages will be stored in Azure Service Bus and sagas in SQL Azure (don't forget to allow access to SQL Azure from your local IP address!).  Run just the API and post to our <code>/newcustomer</code> route and you will see there is a message in Azure Service Bus:</p>\n<p><img src=\"azure-service-bus-message-peek.png\" alt=\"\"></p>\n<p>Run the back end project and you will see in the console that Rebus has created tables and queues for us before processing the waiting message:</p>\n<p><img src=\"rebus-console-azure-backend-first-run.png\" alt=\"\"></p>\n<p>We now just need to publish our two projects and we'll have our onboarding process running in Azure.  Before you do that, you will need to set up your connection strings in your App Service:</p>\n<p><img src=\"azure-app-service-configuration.png\" alt=\"\"></p>\n<p>To publish our backend processor as a Web Job we'll use Visual Studio (as Rider's Azure integration doesn't include Web Job support - but, hey, who knows what we might get for Xmas! :) ).  The process is pretty simple and you can create your App Services along the way if you want:</p>\n<p><img src=\"visual-studio-publish.png\" alt=\"\"></p>\n<p><strong>Tip:</strong> Make sure you set your Web Job to be continuous when you publish:</p>\n<p><img src=\"visual-studio-publish-ensure-continuous.png\" alt=\"\"></p>\n<p>After you've published, check that your back end is working by looking in the Web Job section:</p>\n<p><img src=\"azure-app-service-web-job-running.png\" alt=\"\"></p>\n<p>If it's not running, click on logs to the output and diagnose.  Once it is running then you should be able to post to the <code>/newcustomer</code> API and see the same output we saw in our console in the Web Job logs:</p>\n<p><img src=\"azure-web-job-log-processed.png\" alt=\"\"></p>\n<p>Congratulations - you now have your onboarding business process running in an Azure App Service Web Job and your API entry point running in Azure App Service.</p>\n<p>The code at this point is in the branch <code>8-running-in-azure</code>.</p>\n<p><strong>Update:</strong> There is now also an F# sample in the official Rebus Samples Repo:</p>\n<p><a href=\"https://github.com/rebus-org/RebusSamples\">https://github.com/rebus-org/RebusSamples</a></p>\n<p>Enjoy Rebus!</p>\n",
      "date_published": "2020-12-07T00:00:00Z"
    },{
      "id": "https://seankearon.me/posts/2020/12/rebus-sagas-csharp/",
      "url": "https://seankearon.me/posts/2020/12/rebus-sagas-csharp/",
      "title": "Long-running business processes in C# with Rebus on Azure",
      "content_html": "<p>This post is part of the <a href=\"https://www.csadvent.christmas/\">C# Advent Calendar 2020</a>.  There is an equivalent post in F# <a href=\"https://seankearon.me/posts/2020/11/rebus-sagas-fsharp/\">here</a>.</p>\n<p><strong>Note April 2024:</strong> The original code in this post is based on Rebus 6 and .Net 5.  The code in GitHub has now been updated to Rebus 8 and .Net 8.  Differences can be viewed in the <a href=\"https://github.com/seankearon/rebus-onboardingcs/pull/1\">here</a>.</p>\n<h1 id=\"introduction\" tabindex=\"-1\">Introduction <a class=\"direct-link\" href=\"#introduction\">#</a></h1>\n<p>This post talks about how to build a system that runs a long-running business process (aka workflow or &quot;saga&quot;) using a .Net library called <a href=\"https://github.com/rebus-org/Rebus\">Rebus</a>.</p>\n<p>Rebus is a library that makes it easy to build reliable, distributed systems.  We will show how to host our Rebus system in Azure App Services.  You will also be able to run it by pressing F5 in your IDE.</p>\n<p>We will be implementing a set of fictional, but quite typical business requirements around the onboarding of a new customer.</p>\n<p>So, let's get started!</p>\n<h1 id=\"introducing-rebus\" tabindex=\"-1\">Introducing Rebus <a class=\"direct-link\" href=\"#introducing-rebus\">#</a></h1>\n<p>Rebus is a distributed, asynchronous and durable .Net Service Bus that is a pleasure to use.  I like to think of Rebus as microservices without the <a href=\"https://en.wiktionary.org/wiki/faff\">faff</a>!  It's a .Net library uses messages to communicate between parts of your application and can do that reliably by using one of the various options for transporting and sharing those messages.  Rebus can be anywhere your application is (except on mobile and embedded devices afaik).</p>\n<p>I've been using Rebus for a long time now.  In my current gig, we are using Rebus in a national medicines optimisation healthcare system that serves around 50 million patients across the UK.  Rebus has helped us simplify and centralise a lot of complex, legacy back end processing and allow us to move the system from on-prem to the cloud.</p>\n<p>As a &quot;message-based architecture&quot;, Rebus is similar to other .Net Service Buses such as NServiceBus, Mass Transit or EasyNetQ.  Like these other service buses, Rebus uses a push model where it reacts to incoming messages.  This is distinct to streaming approaches such as used by Kafka, etc.</p>\n<p>Rebus is open source (MIT), completely free to use and has around 1.4K GitHub stars.  It is Danish software and the founder and primary maintainer is Mogens Heller Grabe (<a href=\"https://twitter.com/mookid8000\">@mookid8000</a>).  Mogens runs a company that provides consultancy, support and some rather excellent monitoring software for use with Rebus (more details here: <a href=\"https://rebus.fm/services/\">https://rebus.fm/services/</a>).</p>\n<p>Thanks to Mogens for kindly reviewing the content of this post.</p>\n<h1 id=\"what-good-things-does-rebus-bring-us%3F\" tabindex=\"-1\">What good things does Rebus bring us? <a class=\"direct-link\" href=\"#what-good-things-does-rebus-bring-us%3F\">#</a></h1>\n<p>Rebus brings high levels of reliability to your system.  Each message will either be processed or sent to an error queue so that you can fix the problem and replay it later.</p>\n<p>Rebus naturally breaks your system down into small chunks of functionality called handlers that are easy to write, reason about and test.  I find working with Rebus to be a very good developer experience (and the error messages are really useful too!).</p>\n<p>One or more handlers can respond to and process messages, which makes it very easy to extend your system without changing existing code.  Different handlers that process the same message do not need to be in the same application component.  This makes it easy to architect your application in a manner that supports your performance, scaling and security needs.</p>\n<p>Rebus can use various technologies to store messages that are being processed.  These are called <a href=\"https://github.com/rebus-org/Rebus/wiki/Transport\">message transports</a> and include RabbitMQ, Azure Service Bus, Amazon SQS and various databases.  There are also transports that use the file system or in-memory.  Rebus relies on the transport to provide durability and reliability, so you probably don't want to use the in-memory transport when you care about losing messages!  If Rebus can't process a message then it can retry that processing either in using a <a href=\"https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#customizing-retries\">simple approach</a>, using a <a href=\"https://github.com/rebus-org/Rebus/wiki/Back-off-strategy\">back-off strategy</a> and you can also add a <a href=\"https://github.com/rebus-org/Rebus/wiki/Automatic-retries-and-error-handling#second-level-retries\">second layer of processing</a> for a more comprehensive approach to handling failures.</p>\n<p>Ultimately, if the message can't be processed for whatever reason, then Rebus will keep it for you in the part of the transport that you nominate as the error queue when you configure Rebus.  As well as the message, Rebus also stores the details of the failures in the message's headers so that you can easily see what went wrong and fix it.  When you've put the database server's plug back into the wall, or fixed the cause of the failure in some other way, you can move the message back to the processing queue so that processing can begin again!</p>\n<p>There are plenty of other good things in Rebus that we don't have time to talk about here, such as</p>\n<ul>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Data-bus\">Transporting larger data using the Data Bus</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Workers-and-parallelism\">Controlling the number of workers and parallelism</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Wire-level-format-of-messages\">Controlling how Rebus serialises messages</a>.</li>\n<li><a href=\"https://github.com/rebus-org/Rebus/wiki/Message-compression-and-encryption\">Compressing and encrypting the contents of messages</a></li>\n</ul>\n<p>As you'd expect, there is superb support for <a href=\"https://github.com/rebus-org/Rebus/wiki/Testing\">testing too</a>!</p>\n<p>Check out the official wiki here:</p>\n<p><a href=\"https://github.com/rebus-org/Rebus/wiki\">https://github.com/rebus-org/Rebus/wiki</a></p>\n<h1 id=\"overview-of-our-scenario\" tabindex=\"-1\">Overview of our scenario <a class=\"direct-link\" href=\"#overview-of-our-scenario\">#</a></h1>\n<p>We are going to jump into Rebus a little beyond the basics of request/reply or pub/sub and look at how to model long-running, durable workflows (aka sagas) in Rebus.  We are going to use Rebus to build an application that processes new customers for a hypothetical business and then host that in an Azure App Service.  You could also run the same code as a Windows Service if you want, and it will run just the same in your IDE when you press F5 (or whatever you press to run your shizzle!).</p>\n<p>We're going to add a few requirements into our made-up business scenario, just so that we can showcase some of Rebus' features.  Let's take a look at the business requirements.</p>\n<p>We're going to model a business process that is under an <a href=\"https://en.wikipedia.org/wiki/Operational-level_agreement\">OLA</a> and which has compensating actions that must be taken if the requirements in the OLA are not met.</p>\n<p>The business wants us to build a system to handle the onboarding of new customers.  As well as functional requirements, the business also have operational requirements so that they can meet their <a href=\"https://en.wikipedia.org/wiki/Operational-level_agreement\">operational level agreements (OLA)</a>.  When a new customer is taken on, the business wants the following to happen:</p>\n<ul>\n<li>An account is to be created for the customer.</li>\n<li>A welcome email is to be sent to the customer after the account is created.</li>\n<li>A sales call is scheduled in the CRM after the account has been created.</li>\n</ul>\n<p>The business has an OLA in place that stipulates that new customers must be processed within a given time.  So that they can meet their OLA requirements, they want our workflow to complete within 10 minutes of the customer being taken on.  If the workflow does not complete within 10 minutes, the business wants the following to happen:</p>\n<ul>\n<li>Any placed sales call is to be cancelled.</li>\n<li>The service desk takes over the process.</li>\n</ul>\n<p>Great - we know what they want.  So, let's start building it!</p>\n<h1 id=\"our-architecture\" tabindex=\"-1\">Our architecture <a class=\"direct-link\" href=\"#our-architecture\">#</a></h1>\n<p>Our architecture is very simple.  This is what it looks like:</p>\n<p><img src=\"customer-onboarding-architecture.png\" alt=\"\"></p>\n<p>There is a web API that serves as an entry point to let us know about the new customer.  There is a back end processing system that does all our processing.  There is also a CRM and a customer database.</p>\n<p>We are going to build the entry point API and the back end processing system.  We are going to pretend that the CRM and the database exist.</p>\n<p>Rebus will be used in the web API and the back end processing system.</p>\n<h1 id=\"setting-up-the-projects\" tabindex=\"-1\">Setting up the projects <a class=\"direct-link\" href=\"#setting-up-the-projects\">#</a></h1>\n<p>We're going to be using .Net 5, and I'll be using JetBrains Rider, but you can use your IDE of choice!  We're going to build everything so that it runs on our local machines and then migrate it to the Cloud later.  You can find the code in GitHub here:</p>\n<p><a href=\"https://github.com/seankearon/rebus-onboardingcs.git\">https://github.com/seankearon/rebus-onboardingcs.git</a></p>\n<p>So that you can skip ahead, there are branches that have the outcomes of the stages as mentioned below.</p>\n<p>The basic setup is to create a project for our Web API and a Console App project for our back end processor.  We'll call these EntryPointAPI and OnboardingProcessor respectively.  We'll see later how to run this locally, in an Azure App Service or a Windows Service.</p>\n<p>Then we add the <a href=\"https://www.nuget.org/packages/Rebus\">Rebus</a> and <a href=\"https://www.nuget.org/packages/Rebus.ServiceProvider\">Rebus.ServiceProvider</a> NuGet packages to each project, giving us something like this:</p>\n<p><img src=\"1-basic-project-cs.png\" alt=\"\"></p>\n<p>This stage is available on the branch <em>1-basic-project-setup</em>.</p>\n<h1 id=\"defining-our-messages\" tabindex=\"-1\">Defining our messages <a class=\"direct-link\" href=\"#defining-our-messages\">#</a></h1>\n<p>So, now we have a couple of projects waiting for some code, we need to think about what we're going to build!  In a message-based system, a good place to start is designing your messages.</p>\n<p>In Rebus, you model your messages as <a href=\"https://en.wikipedia.org/wiki/Plain_old_CLR_object\">POCOs</a>.  Messages will be used by different parts of our system, so we'll put them into a shared assembly.  Messages should also be small and immutable.  (Rebus does allow mutating a message but, as processing is asynchronous, it's not a good idea as it can lead to unpredictable behaviour.  If you find you need to change the message state during processing then look at using another message to model the state changes.)</p>\n<h2 id=\"events-and-commands\" tabindex=\"-1\">Events and commands <a class=\"direct-link\" href=\"#events-and-commands\">#</a></h2>\n<p>Before we look at our requirements and start building our messages, let's take a moment to look at two types of messages.</p>\n<p>Messages split into two broad categories: events and commands.  These correspond to the general meaning of the words with an event being a general notification that something has occurred (i.e. in the past), and a command is a when you tell a component to do something.</p>\n<p>To send a command in Rebus you use either <code>IBus.Send()</code> or <code>IBus.SendLocal()</code> to send the message to a specific queue.  The difference between those calls is that with <code>IBus.Send()</code> you need to use Rebus' routing to tell Rebus where to send the message, but <code>IBus.SendLocal()</code> always sends the message to the current endpoint's queue.</p>\n<h2 id=\"our-first-set-of-messages\" tabindex=\"-1\">Our first set of messages <a class=\"direct-link\" href=\"#our-first-set-of-messages\">#</a></h2>\n<p>Let's leave the OLA requirements to one side for now and look at our main requirements.  These say that when a customer is onboarded that:</p>\n<ul>\n<li>An account is to be created for the customer.</li>\n<li>A welcome email is to be sent to the customer after the account is created.</li>\n<li>A sales call is scheduled in the CRM after the account has been created.</li>\n</ul>\n<p>So, if we were sitting in a room together and someone was telling us what to do, they'd probably say something like this:</p>\n<p>&quot;Create an account for Sean.&quot;<br>\n&quot;Account created for Sean.&quot;<br>\n&quot;Send a welcome email to Sean.&quot;<br>\n&quot;Schedule a sales call with Sean.&quot;<br>\n&quot;Welcome email sent to Sean&quot;<br>\n&quot;Sales call scheduled with to Sean&quot;</p>\n<p>Someone is listening and ticks off what has been done.  If the process doesn't finish in time then they tell everyone to stop.  Check if the sales call should be cancelled and tell the service desk to take over.</p>\n<p>So, that looks like three commands and an event to me!  As it's good for messages to be immutable, let's use C# 9's new records feature to implement our messages, which gives us:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">OnboardNewCustomer</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name  <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Email <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">CreateCustomerAccount</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Name  <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Email <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">CustomerAccountCreated</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> Email      <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span>    CustomerId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">SendWelcomeEmail</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> CustomerId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">WelcomeEmailSent</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> CustomerId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">ScheduleSalesCall</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> CustomerId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">record</span> <span class=\"token class-name\">SalesCallScheduled</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span> CustomerId <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">init</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Generally, you will want your messages to contain as little information as possible.  After the customer has been created, we then use the ID of the customer.  We use the <code>CustomerAccountCreated</code> message to let us know what ID the new customer has been assigned.  We will see how that is used later.</p>\n<p>This stage is available on the branch <em>2-main-messages-added</em></p>\n<h1 id=\"creating-the-web-api-entry-point\" tabindex=\"-1\">Creating the web API entry point <a class=\"direct-link\" href=\"#creating-the-web-api-entry-point\">#</a></h1>\n<p>The next job is to make our web API tell the backend about any new customers.  We'll just add a simple route to allow posting of a name and email.</p>\n<blockquote>\n<p>POST /newcustomer?name=my name&amp;email=me@my.email</p>\n</blockquote>\n<p>When we receive such a <code>POST</code> request then we will start the onboarding process by sending a <code>CreateCustomerAccount</code> message to the bus and respond with a <code>200 OK</code>.</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OnboardNewCustomer</span> <span class=\"token punctuation\">{</span> Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">,</span> Email <span class=\"token operator\">=</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">return</span> <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>To do this, we need to set up Rebus in our web API.  There are two basic modes of operation for Rebus &quot;out of the box&quot;: normal and one-way client.  The one-way client mode &quot;does what it says on the tin&quot; and allows you to send messages from a component.  In normal mode, Rebus can send and receive messages.  You can read more about those <a href=\"https://github.com/rebus-org/Rebus/wiki/Different-bus-modes\">here</a>.</p>\n<p>We are going to set up Rebus inside our .Net 5 web API and inject an instance of the Rebus <code>IBus</code> into our controller.  Remember, at this stage, we are just using the file system as our transport and will be adding Azure later.  In time-honoured fashion, let's use an extension method to configure and register an <code>IBus</code> instance and then inject that into our controller.</p>\n<p>In <code>Startup.cs</code> we will add one call to our configure services method:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">ConfigureServices</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddControllers</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span>\n\n    <span class=\"token comment\">// This configures and registers Rebus.</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebusAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>In our controller, we add a constructor parameter for the <code>IBus</code> so that it will be injected into the instance.  Our controller method can then send the message to the bus, making our controller class look like this:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">ApiController</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CustomerController</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ControllerBase</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IBus</span> _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">CustomerController</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus <span class=\"token operator\">=</span> bus<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">HttpPost</span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">Route</span><span class=\"token attribute-arguments\"><span class=\"token punctuation\">(</span><span class=\"token string\">\"newcustomer\"</span><span class=\"token punctuation\">)</span></span></span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span>IActionResult<span class=\"token punctuation\">></span></span> <span class=\"token function\">NewCustomer</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> name<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OnboardNewCustomer</span> <span class=\"token punctuation\">{</span> Name <span class=\"token operator\">=</span> name<span class=\"token punctuation\">,</span> Email <span class=\"token operator\">=</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> <span class=\"token function\">Ok</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Pretty simple, right?  All that remains now is to look at the configuration in our extension method.  This looks like:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddRebusAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        cfg <span class=\"token operator\">=></span> cfg\n           <span class=\"token punctuation\">.</span>Logging   <span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>                                               <span class=\"token comment\">// A</span>\n           <span class=\"token punctuation\">.</span>Routing   <span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>        <span class=\"token comment\">// B</span>\n           <span class=\"token punctuation\">.</span>Transport <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystemAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>          <span class=\"token comment\">// C</span>\n           <span class=\"token punctuation\">.</span>Options   <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueAddress</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// D</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>So, in our configuration we do the following:</p>\n<p><strong>A:</strong> We tell Rebus to log to the console.</p>\n<p><strong>B:</strong> We tell Rebus where to send the <code>OnboardNewCustomer</code> messages.  In Rebus, messages go to &quot;queues&quot;.</p>\n<p><strong>C:</strong> we tell Rebus to use the file system to transport messages, and we tell Rebus that we will only ever be sending messages.</p>\n<p><strong>D:</strong> we tell Rebus to retry any failures (the default is 5 times, but you can set that as you wish) and to send messages that are still failing log to the queue called &quot;ErrorQueue&quot;.</p>\n<p>This configuration will change a little later when we use Azure ServiceBus as our message transport.  But, we're now ready to start sending messages.  Woohoo!</p>\n<p>The code at this point is available in the branch <code>3-entry-point-api-working</code>.  Go and run that, crank up your favourite HTTP tool and send the following to your new API (don't forget to add the host!):</p>\n<blockquote>\n<p>POST /newcustomer?name=Sean&amp;email=sean@my.email</p>\n</blockquote>\n<p><strong>Aside:</strong> If you're using Rider, you can run the line above from  <a href=\"https://www.jetbrains.com/help/rider/Http_client_in__product__code_editor.html\">Rider's built-in HTTP client</a>.  How cool is that? :)</p>\n<p>Then you will see a file has appeared in <code>c:/rebus-advent/MainQueue</code>.  We can just open that up to see that a message in Rebus consists of a set of headers and a body:</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"Headers\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">\"rbs2-intent\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"p2p\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-msg-id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"323e07bb-4dd2-43b4-af5d-9c5749742cd7\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-senttime\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2020-11-10T11:17:26.1492853+00:00\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-msg-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"OnboardingMessages.OnboardNewCustomer, OnboardingMessages\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-corr-id\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"323e07bb-4dd2-43b4-af5d-9c5749742cd7\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-corr-seq\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token property\">\"rbs2-content-type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json;charset=utf-8\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Body\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"eyIkdHlwZSI6Ik9uYm9hcmRpbmdNZXNzYWdlcy5PbmJvYXJkTmV3Q3VzdG9tZXIsIE9uYm9hcmRpbmdNZXNzYWdlcyIsIk5hbWUiOiJTZWFuIiwiRW1haWwiOiJzZWFuQG15LmVtYWlsIn0=\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The body is Base64 encoded JSON that is our serialised message:</p>\n<pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"$type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"OnboardingMessages.OnboardNewCustomer, OnboardingMessages\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Sean\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"Email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"sean@my.email\"</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<h1 id=\"a-quick-review\" tabindex=\"-1\">A quick review <a class=\"direct-link\" href=\"#a-quick-review\">#</a></h1>\n<p>So, to add Rebus to our normal .Net Web API project we have:</p>\n<ul>\n<li>Defined our messages.</li>\n<li>Added around 4 lines of configuration.</li>\n<li>Registered Rebus into .Net 5's DI.</li>\n<li>Sent the message into our bus directly from our controller method.</li>\n</ul>\n<p>Because of the reliability and durability that Rebus' brings, any client that calls our <code>/newcustomer</code> API and receives a <code>200 OK</code> knows that the onboarding process has now started and that it will be processed as expected.</p>\n<p>That's a good start!  Let's move on to creating the back end of our system that is going to process the messages from the API.</p>\n<h1 id=\"creating-the-back-end\" tabindex=\"-1\">Creating the back end <a class=\"direct-link\" href=\"#creating-the-back-end\">#</a></h1>\n<p>The way we set up Rebus in the back end is going to be very similar to how we did that in the API.  There are some essential differences that we will focus on:</p>\n<ul>\n<li>The back end needs to send <em>and</em> receive messages.</li>\n<li>The back end will be performing a long-running, durable workflow/saga.</li>\n<li>We want to be able to host the back end in an Azure App Service, as well as run it locally (and, possibly, in a Windows Service).</li>\n</ul>\n<h2 id=\"configuring-rebus-for-send-and-receive\" tabindex=\"-1\">Configuring Rebus for send and receive <a class=\"direct-link\" href=\"#configuring-rebus-for-send-and-receive\">#</a></h2>\n<p>Next, we are going to configure Rebus for our back end.  So that we can run locally or in an Azure App Service, we are going to use a library called <a href=\"https://github.com/rebus-org/Topper\">Topper</a> form the creator of rebus, Mogens (here's <a href=\"https://rebus.fm/2019/01/29/generic-host/\">Mogens' blog</a> introducing Topper..  Under the hood, Topper uses the venerable <a href=\"http://topshelf-project.com/\">Topshelf library</a> and requires us to implement our back end as an <code>IDisposable</code> wrapper and run it inside a Console application project.</p>\n<p>I'm going to sprinkle in a little bit of <a href=\"https://github.com/serilog/serilog\">Serilog</a> too, just for fun.  Our entry point will look like the following:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Program</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Main</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Log<span class=\"token punctuation\">.</span>Logger <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">LoggerConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>WriteTo<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">CreateLogger</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> configuration <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"OurBackendBus\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Backend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        ServiceHost<span class=\"token punctuation\">.</span><span class=\"token function\">Run</span><span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>That all we need to do to set up for running locally or in Azure.  We can also create and run it as a Windows Service just by calling the executable using the parameter <code>install</code> (use <code>uninstall</code> to remove the service).  Very cool!</p>\n<p>The rest of the magic all happens in our <code>Backend</code> class.  Let's take a look at that class:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Backend</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IDisposable</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">ServiceProvider</span> _provider<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">private</span>          <span class=\"token class-name\">IBus</span>            _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">Backend</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> services <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ServiceCollection</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebusAsSendAndReceive</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _provider <span class=\"token operator\">=</span> services<span class=\"token punctuation\">.</span><span class=\"token function\">BuildServiceProvider</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _provider<span class=\"token punctuation\">.</span><span class=\"token function\">UseRebus</span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> _bus <span class=\"token operator\">=</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus<span class=\"token punctuation\">?.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        _provider<span class=\"token punctuation\">?.</span><span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>And, like previously, we've put the configuration spell into an extension method, which looks like this:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddRebusAsSendAndReceive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        cfg <span class=\"token operator\">=></span> cfg\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Logging</span><span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Serilog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">MapAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Options</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueAddress</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Sagas</span><span class=\"token punctuation\">(</span>s <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">UseFilesystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent/sagas\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AutoRegisterHandlersFromAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Backend<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>This is very similar to the previous one, but we are not using the <code>*AsOneWayClient</code> flavours of the configuration methods.  We are going to be dealing with more than one message in our back end, so the routing maps all messages from the assembly to our <code>MainQueue</code>.  The file system transport is two-way and therefore needs to know which queue to work against - that's <code>MainQueue</code> again.  Lastly, we've got a new configuration item to set us up ready for our sagas later on.</p>\n<p>There is one new line that we haven't seen before now: <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;();</code>.  This tells Rebus to scan the assembly to find and register handlers, which in Rebus are types that will process messages.  You can now test that the lovely new backend is working by adding a handler for the <code>OnboardNewCustomer</code> message, as follows:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">DummyHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnboardNewCustomer</span> message<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotImplementedException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>If you have a message waiting in the queue from before, then this will be found and Rebus will pass it to the handler above and can break in your IDE to see that the data from our earlier message is passed into our handler.  If you don't have a message waiting, just use the API to send one.</p>\n<p><img src=\"cs-break-in-handler.png\" alt=\"\"></p>\n<p>You can also see the logging output in the console:</p>\n<p><img src=\"rebus-console-output.png\" alt=\"\"></p>\n<p>If you allow the program to run, you'll see in the console that Rebus will retry the message 5 times - getting our <code>NotImplementedException</code> each time, and then the message is moved to our <code>ErrorQueue</code>:</p>\n<p><img src=\"message-in-error-queue-filesystem.png\" alt=\"\"></p>\n<p>Just drag it back to the <code>MainQueue</code> to start processing again!</p>\n<p>You can find the code at this point on the branch <code>4-back-end-configuration</code>.</p>\n<p><strong>Aside:</strong>  Did you see what happened there?  Our system didn't stop working just because the back end component was down (okay, not even written yet!!).  The message stayed in the queue and waited until there was something to process it.  That's a nice example of how using Rebus increases the reliability of your system.</p>\n<h2 id=\"creating-the-saga\" tabindex=\"-1\">Creating the saga <a class=\"direct-link\" href=\"#creating-the-saga\">#</a></h2>\n<p>Okay, we're ready now to create our saga, the code that will run our workflow.  Rebus models sagas by implementing two connected classes.  One that holds any state that changes throughout the workflow, and one that is responsible for coordinating the work done throughout the long-running process.  This is what the basic structures look like:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnboardingSagaData</span><span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ISagaData</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Guid</span> Id       <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span>  Revision <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnboardingSaga</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Saga<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span><span class=\"token punctuation\">,</span> <span class=\"token class-name\">IAmInitiatedBy<span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ICorrelationConfig<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span> config<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnboardNewCustomer</span> message<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token range operator\">..</span><span class=\"token punctuation\">.</span> <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>The <code>OnboardingSagaData</code> class has the <code>Id</code> and <code>Revision</code> properties from the <code>ISagaData</code> interface so that Rebus can control concurrent access to the saga's state for us.</p>\n<p>Each time a customer is onboarded, there will be a saga instance that is responsible for controlling the onboarding workflow for that customer.  The <code>CorrelateMessages</code> method in the  <code>OnboardingSaga</code> class is used by Rebus to find the saga instance that relates to a particular message.</p>\n<p>We tell Rebus when to start a new saga by adding the interface <code>IAmInitiatedBy&lt;OnboardNewCustomer&gt;</code>.  Soon, we will add other messages that will be processed by the saga by using the <code>IHandleMessages&lt;T&gt;</code> interface.</p>\n<p>Let's push on and see how this is implemented for the full workflow (except the OLA requirements).</p>\n<p>We need to track what's going on in our workflow.  We do that by adding state to the <code>ISagaData</code> implementation.  We're going to keep hold of the name, email and the new account id and we also want to track what actions have happened.   I've added the <code>IsComplete</code> helper property that we'll use in the saga.</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnboardingSagaData</span><span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">ISagaData</span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Guid</span> Id       <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span>  Revision <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> CustomerName  <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> CustomerEmail <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">int</span></span>    AccountId     <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> AccountCreated     <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> WelcomeEmailSent   <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> SalesCallScheduled <span class=\"token punctuation\">{</span> <span class=\"token keyword\">get</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">;</span> <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">bool</span></span> IsComplete <span class=\"token operator\">=></span> AccountCreated <span class=\"token operator\">&amp;&amp;</span> WelcomeEmailSent <span class=\"token operator\">&amp;&amp;</span> SalesCallScheduled<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>We update the state from inside the handlers in our saga (Rebus makes the saga's data available via the instance's <code>Data</code> property).  For example, when we get a confirmation that the welcome email has been sent:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WelcomeEmailSent</span> m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    Data<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> Task<span class=\"token punctuation\">.</span>CompetedTask<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>At the exit of each handler method, we call <code>TryComplete()</code>.  This method checks to see that we've done everything we want to do and, if so, we call the Rebus' <code>MarkAsComplete()</code> method.   Rebus will then remove clean up and remove the saga's state for us.  We call this every time as Rebus, being distributed and asynchronous, may have finished up the saga in the blink of an eye!  (Okay, we probably don't need to call it at the end of the initiating method, but I like to do that for consistency!)  This is our <code>TryComplete()</code> method:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">.</span>IsComplete<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">MarkAsComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Rebus needs to know how to find the saga state for our particular workflow, and we have updated the <code>CorrelateMessages</code> method with the necessary code to let Rebus do just that:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ICorrelationConfig<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span> config<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span>    <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span>      <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>CustomerEmail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span>      <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>CustomerEmail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">></span></span></span>      <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">></span></span></span>    <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>The configuration allows you to correlate a property value in each message handled by the saga with a value in the saga's state.  You just need to make sure Rebus can uniquely identify the saga from these values and then sit back and let Rebus do all the finding for you!  We're using the email and the account ID when it's known.  Note that you need to supply a correlation for Rebus to identify all messages to which the saga responds, including the message that initiates the saga.</p>\n<p>All that remains is to do some work inside the saga.  Generally, I like to keep my sagas pretty &quot;slim&quot; and make them responsible for coordinating the flow of work.  I tend to pass off work to other handlers by sending messages out from the saga.  Here's how that looks in the saga's initiating handler:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnboardNewCustomer</span> m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>IsNew<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n    Data<span class=\"token punctuation\">.</span>CustomerName  <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">;</span>\n    Data<span class=\"token punctuation\">.</span>CustomerEmail <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CreateCustomerAccount</span> <span class=\"token punctuation\">{</span>Name <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> Email <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>In the first line we check that the saga hasn't already been created by another process and abandon if so.  Then, after setting some state, we use the Rebus <code>IBus</code> instance has been injected into our saga to send a command message to create an account for the customer details we have been given.</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CreateCustomerAccount</span> <span class=\"token punctuation\">{</span>Name <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> Email <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>As our requirements say that everything else should happen <em>after</em> the account has been created, that's all we need to do there.</p>\n<p>The full code looks like this:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnboardingSaga</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Saga<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IAmInitiatedBy<span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IBus</span> _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">OnboardingSaga</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus <span class=\"token operator\">=</span> bus<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">.</span>IsComplete<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">MarkAsComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ICorrelationConfig<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span> config<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span>    <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span>     <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>CustomerEmail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span>     <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>CustomerEmail<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">></span></span></span>      <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">></span></span></span>    <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnboardNewCustomer</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>IsNew<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n        Data<span class=\"token punctuation\">.</span>CustomerName  <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">;</span>\n        Data<span class=\"token punctuation\">.</span>CustomerEmail <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CreateCustomerAccount</span> <span class=\"token punctuation\">{</span>Name <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> Email <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CustomerAccountCreated</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Data<span class=\"token punctuation\">.</span>AccountId <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">;</span>\n        Data<span class=\"token punctuation\">.</span>AccountCreated <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SendWelcomeEmail</span>  <span class=\"token punctuation\">{</span>AccountId <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">ScheduleSalesCall</span> <span class=\"token punctuation\">{</span>AccountId <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">WelcomeEmailSent</span> _<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Data<span class=\"token punctuation\">.</span>WelcomeEmailSent <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> Task<span class=\"token punctuation\">.</span>CompletedTask<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SalesCallScheduled</span> _<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Data<span class=\"token punctuation\">.</span>SalesCallScheduled <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">TryComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> Task<span class=\"token punctuation\">.</span>CompletedTask<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The code at this stage is available in the branch <code>5-saga-receives-messages</code>.</p>\n<p>If you check that out, run it and start the saga by posting to our API, then the message will fail and be placed in the error queue after be retried only once.  If you open up the message, you'll see something like this:</p>\n<p><img src=\"failed-message-with-error-in-header.png\" alt=\"\"></p>\n<p>Look inside the <code>rbs2-error-details</code> header and you will see that Rebus has stored the exception details in there for use.  They tell us this:</p>\n<pre><code>Message with ID db52a43d-a6bc-4a9d-a6c3-3d4a324fcaba\nand type OnboardingMessages.CreateCustomerAccount, OnboardingMessages\ncould not be dispatched to any handlers\n(and will not be retried under the default fail-fast settings)\n</code></pre>\n<p>This lovely, helpful error shows what Rebus puts messages onto the error queue if it cannot find any handlers to process it.  The &quot;fail-fast&quot; part is Rebus' built-in mechanism to skip retries when you are sure there is no point.</p>\n<h2 id=\"creating-the-remaining-handlers\" tabindex=\"-1\">Creating the remaining handlers <a class=\"direct-link\" href=\"#creating-the-remaining-handlers\">#</a></h2>\n<p>In a real-world application, you might choose to create another Rebus endpoint for one or more of the handlers we are going to create.  This could be because you want to deploy it separately for performance or other reasons.  Rebus makes it easy to structure your application how you want.  For us, we're going to put them all into the single endpoint - that's fine too! :)</p>\n<p>We need handlers that do the following:</p>\n<ul>\n<li>Create a customer account.</li>\n<li>Send a welcome email.</li>\n<li>Schedule a sales call.</li>\n</ul>\n<p>As we saw briefly above with our <code>DummyHandler</code>, a handler is just a class that implements the <code>IHandleMessages&lt;T&gt;</code> interface.  So, we need the following handlers:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CreateCustomerAccountHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>CreateCustomerAccount<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IBus</span> _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">CreateCustomerAccountHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus <span class=\"token operator\">=</span> bus<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CreateCustomerAccount</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CustomerAccountCreated</span> <span class=\"token punctuation\">{</span>Email <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>Email<span class=\"token punctuation\">,</span> AccountId <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">Next</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SendWelcomeEmailHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>SendWelcomeEmail<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IBus</span> _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">SendWelcomeEmailHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus <span class=\"token operator\">=</span> bus<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SendWelcomeEmail</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">WelcomeEmailSent</span> <span class=\"token punctuation\">{</span> AccountId <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ScheduleSalesCallHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>ScheduleSalesCall<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> <span class=\"token class-name\">IBus</span> _bus<span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token function\">ScheduleSalesCallHandler</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">IBus</span> bus<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        _bus <span class=\"token operator\">=</span> bus<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ScheduleSalesCall</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Pretend we're doing something!</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SalesCallScheduled</span> <span class=\"token punctuation\">{</span> AccountId <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>The fact that we included the line <code>services.AutoRegisterHandlersFromAssemblyOf&lt;Backend&gt;()</code> in our Rebus setup means that we can put those handlers anywhere in our back end project.  Rebus will find them and set them up so that they are ready to use.</p>\n<p>You will notice that each handler notifies the saga that it was completed, sometimes passing back new information - such as the account ID.  It's perfectly possible to use the <code>IBus.Send*()</code> methods to do that.  But, I'm using  <code>IBus.Reply()</code> which replies to the Rebus endpoint/queue that the message came from.  That is a nice way to avoid having to think about whether I've configured the routing for that message!</p>\n<p>One of the joys of developing against the file system transport is that you can easily look into what Rebus is doing.  Just put a breakpoint in one of your handlers, use the API to start the onboarding process and you'll see the messages and saga state being updated on disk as you step through.</p>\n<p><img src=\"saga-in-action-filesystem.png\" alt=\"\"></p>\n<p>Congratulations!  If you've followed this far, you now have a long-running, durable workflow implemented in Rebus!</p>\n<p>You can get this code at this point from the branch <code>6-saga-processes-messages</code>.  I've added some logging to that so that you can watch things happening from the console too, so you should see something like this:</p>\n<p><img src=\"saga-logging-output.png\" alt=\"\"></p>\n<p><strong>Aside:</strong> There are two versions of this post - one using C# and one using F#.  Just for fun, why not try running the API from the <a href=\"https://github.com/seankearon/rebus-onboardingcs\">C# project</a> and the backend from the <a href=\"https://github.com/seankearon/rebus-onboardingfs\">F# project</a>?  As long as you're using the same transport (at this stage that's file-system in <code>c:\\rebus-advent</code>) then everything will work just fine.  How lovely is that? :)</p>\n<h2 id=\"adding-ola-support\" tabindex=\"-1\">Adding OLA support <a class=\"direct-link\" href=\"#adding-ola-support\">#</a></h2>\n<p>Okay, so that's most of our requirements covered.  We only have the OLA to add in.  The requirement was that if the workflow does not complete within 10 minutes, the business want the following to happen:</p>\n<ul>\n<li>Any placed sales call is to be cancelled.</li>\n<li>The service desk takes over the process.</li>\n</ul>\n<p>To implement this, we're going to use a cool Rebus feature: deferred messages (which are talked about in the <a href=\"https://github.com/rebus-org/Rebus/wiki/Timeout-Manager\">timeout manager section</a> of the Rebus wiki).  Using this feature we can send ourselves a message that will be received at a time in the future.  If that message is received before the saga completes then we know that our time is up!  We send it like this:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Defer</span><span class=\"token punctuation\">(</span>TimeSpan<span class=\"token punctuation\">.</span><span class=\"token function\">FromSeconds</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">OnboardingOlaBreached</span> <span class=\"token punctuation\">{</span>SagaId <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>When we get that, we just handle it like any other message.  Here's the handler to meet our OLA breach requirements:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">OnboardingOlaBreached</span> m<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>Data<span class=\"token punctuation\">.</span>SalesCallScheduled<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">CancelSalesCall</span> <span class=\"token punctuation\">{</span>AccountId <span class=\"token operator\">=</span> Data<span class=\"token punctuation\">.</span>AccountId<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Send</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">NotifyServiceDesk</span> <span class=\"token punctuation\">{</span>Message <span class=\"token operator\">=</span> <span class=\"token interpolation-string\"><span class=\"token string\">$\"Customer onboarding OLA breach pending for new customer </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">Data<span class=\"token punctuation\">.</span>CustomerName</span><span class=\"token punctuation\">}</span></span><span class=\"token string\"> with email </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">Data<span class=\"token punctuation\">.</span>CustomerEmail</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token function\">MarkAsComplete</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>We send a message to cancel the sales call and then send another message to notify the service desk that bad things are about to happen!  After that, we call <code>MarkAsComplete()</code> to close the saga.</p>\n<p>Don't forget that we need to set up a correlation for our timeout message and add the interface to the saga's signature:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">protected</span> <span class=\"token keyword\">override</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">CorrelateMessages</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">ICorrelationConfig<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span> config<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// snip</span>\n    config<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Correlate</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardingOlaBreached<span class=\"token punctuation\">></span></span></span> <span class=\"token punctuation\">(</span>x <span class=\"token operator\">=></span> x<span class=\"token punctuation\">.</span>SagaId<span class=\"token punctuation\">,</span> <span class=\"token keyword\">nameof</span><span class=\"token punctuation\">(</span>OnboardingSagaData<span class=\"token punctuation\">.</span>Id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">OnboardingSaga</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">Saga<span class=\"token punctuation\">&lt;</span>OnboardingSagaData<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IAmInitiatedBy<span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>CustomerAccountCreated<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>WelcomeEmailSent<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>SalesCallScheduled<span class=\"token punctuation\">></span></span>\n                            <span class=\"token punctuation\">,</span> <span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>OnboardingOlaBreached<span class=\"token punctuation\">></span></span></span></code></pre>\n<p>We need to add a couple of handlers that will respond to our new fire-and-forget messages.  As these are not responding, they are simpler creatures:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">CancelSalesCallHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>CancelSalesCall<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">CancelSalesCall</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Cancelling sales call for account </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">m<span class=\"token punctuation\">.</span>AccountId</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> Task<span class=\"token punctuation\">.</span>CompletedTask<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NotifyServiceDeskHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>NotifyServiceDesk<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">NotifyServiceDesk</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Log<span class=\"token punctuation\">.</span><span class=\"token function\">Information</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"Notifying the service desk that: </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">m<span class=\"token punctuation\">.</span>Message</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> Task<span class=\"token punctuation\">.</span>CompletedTask<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Lastly, we need to update the configuration spell to tell Rebus where to store timeouts.  We're going to store those in the file system for now:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddRebusAsSendAndReceive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        cfg <span class=\"token operator\">=></span> cfg\n           <span class=\"token comment\">// snip</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Timeouts</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"c:/rebus-advent/timeouts\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre>\n<p>That's all we need to meet the remaining requirements around the OLA and compensating actions.  In the code, we hard wired a 5-second timeout, so we can easily see the timeout in action by increasing the pretend delay in one of our handlers.</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">SendWelcomeEmailHandler</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IHandleMessages<span class=\"token punctuation\">&lt;</span>SendWelcomeEmail<span class=\"token punctuation\">></span></span></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task</span> <span class=\"token function\">Handle</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">SendWelcomeEmail</span> m<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">await</span> Task<span class=\"token punctuation\">.</span><span class=\"token function\">Delay</span><span class=\"token punctuation\">(</span><span class=\"token number\">10000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// This delay will breach our OLA rules!</span>\n        <span class=\"token keyword\">await</span> _bus<span class=\"token punctuation\">.</span><span class=\"token function\">Reply</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">WelcomeEmailSent</span> <span class=\"token punctuation\">{</span> AccountId <span class=\"token operator\">=</span> m<span class=\"token punctuation\">.</span>AccountId <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Now, when we run the saga we will see the delay causing the OLA to become breached and the compensating actions taking over.</p>\n<p><img src=\"saga-logging-output-breached-ola.png\" alt=\"\"></p>\n<p>The code at this point is in the branch <code>7-ola-and-compensating-actions</code>.</p>\n<h1 id=\"migrating-to-the-cloud\" tabindex=\"-1\">Migrating to the Cloud <a class=\"direct-link\" href=\"#migrating-to-the-cloud\">#</a></h1>\n<p>What we have at this point will run in the IDE and can easily be installed as a Windows Service, as mentioned earlier.  All that remains now is to show how easy it is to migrate this to the cloud and run it in an Azure App Service.</p>\n<p>As we do this, you'll notice that all we change is the configuration and the functionality remains the same.  That's pretty awesome!  (Okay, sure, I've added some code to get the .Net <code>IConfiguration</code>, but that doesn't count. :) )</p>\n<p>We have two App Services that will host our entry point API and the back end processing system.  Instead of the file system, we will be using Azure Service Bus for our message transport and a SQL Azure database to store our saga state.</p>\n<p><img src=\"azure-architecture.png\" alt=\"\"></p>\n<p>As you know, we're using  <a href=\"https://github.com/rebus-org/Topper\">Topper</a> so that we can easily run our Rebus back end in the Azure App Service as continuous Web Job.  This means we need to have the App Service configured as <em>always on</em>.  We need to create a database for Rebus to use, but we're Rebus will create the tables if they don't already exist.  The same is true for the queues in our Azure Service Bus.  We need to change our configuration spells a little so that we can use these Azure resources.</p>\n<p><strong>Aside:</strong> In my production systems, I like to control the configuration based on a value in <code>appsettings.json</code>.  That means I always have my local file system transport set up and ready for any debugging I might want to do locally.</p>\n<p>We need to add the <a href=\"https://www.nuget.org/packages/Rebus.AzureServiceBus\">Rebus.AzureServiceBus NuGet</a> to our API and back end projects, and the <a href=\"https://www.nuget.org/packages/Rebus.SqlServer\">Rebus.SqlServer</a> to our back end project.  I'm using a basic SQL Azure database that costs 3.72 per month.  That should be adequate until start onboarding a lot of customers!</p>\n<p><strong>Aside:</strong> To avoid making our connections strings visible in our code, we're going to use .Net 5's built-in <a href=\"https://docs.microsoft.com/en-us/aspnet/core/security/app-secrets?view=aspnetcore-5.0&amp;tabs=windows\">secret management</a>.  You could also just store those in your <code>appsettings.json</code> while testing the code and not check them in!</p>\n<p>You can access your Azure Service Bus connection string from the <strong>Shared access policies</strong> in the portal:</p>\n<p><img src=\"azure-service-bus-connection-string.png\" alt=\"\"></p>\n<p><strong>Tip:</strong> you can set your user secrets from the command line in the project folder: <code>dotnet user-secrets set &quot;ConnectionStrings:MsSqlConnectionString&quot; &quot;you connection string&quot;</code>.</p>\n<p>Here is the adjusted configuration spell for the back end:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddRebusAsSendAndReceive</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IConfiguration</span> config<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        rebus <span class=\"token operator\">=></span> rebus\n           <span class=\"token punctuation\">.</span>Logging  <span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Serilog</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Routing  <span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">MapAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseAzureServiceBus</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AzureServiceBusConnectionString\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">AutomaticallyRenewPeekLock</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueAddress</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Options  <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">EnableMessageAuditing</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">auditQueue</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"AuditQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span>Sagas    <span class=\"token punctuation\">(</span>s <span class=\"token operator\">=></span> s<span class=\"token punctuation\">.</span><span class=\"token function\">StoreInSqlServer</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">[</span><span class=\"token string\">\"MsSqlConnectionString\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"Sagas\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"SagaIndexes\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    services<span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">AutoRegisterHandlersFromAssemblyOf</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>Backend<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>You can see that the <code>.Transport</code> has changed to use Azure Service Bus (and that we allow Rebus to automatically renew peek locks on our behalf) and that the <code>.Sagas</code> configuration now uses SQL Server.  If you're paying attention, you might have noticed that there is no longer an item to configure timeout storage.  That is because Rebus is using native behaviour in Azure Service Bus to achieve that (as it does with subscription storage, which is beyond the scope of this article). Nice!</p>\n<p>Just so we can see what's happened, we've turned on message auditing using <code>.EnableMessageAuditing(...)</code>.  Rebus will now put a copy of every processed message into the queue we nominate.</p>\n<p>The configuration spell for the API is adjusted similarly:</p>\n<pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">void</span></span> <span class=\"token function\">AddRebusAsOneWayClient</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> <span class=\"token class-name\">IServiceCollection</span> services<span class=\"token punctuation\">,</span> <span class=\"token class-name\">IConfiguration</span> config<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    services<span class=\"token punctuation\">.</span><span class=\"token function\">AddRebus</span><span class=\"token punctuation\">(</span>\n        rebus <span class=\"token operator\">=></span> rebus\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Logging</span><span class=\"token punctuation\">(</span>l <span class=\"token operator\">=></span> l<span class=\"token punctuation\">.</span><span class=\"token function\">Console</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Routing</span><span class=\"token punctuation\">(</span>r <span class=\"token operator\">=></span> r<span class=\"token punctuation\">.</span><span class=\"token function\">TypeBased</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token generic-method\"><span class=\"token function\">Map</span><span class=\"token generic class-name\"><span class=\"token punctuation\">&lt;</span>OnboardNewCustomer<span class=\"token punctuation\">></span></span></span><span class=\"token punctuation\">(</span><span class=\"token string\">\"MainQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Transport</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">UseAzureServiceBusAsOneWayClient</span><span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span><span class=\"token function\">GetConnectionString</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"AzureServiceBusConnectionString\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n           <span class=\"token punctuation\">.</span><span class=\"token function\">Options</span><span class=\"token punctuation\">(</span>t <span class=\"token operator\">=></span> t<span class=\"token punctuation\">.</span><span class=\"token function\">SimpleRetryStrategy</span><span class=\"token punctuation\">(</span><span class=\"token named-parameter punctuation\">errorQueueAddress</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"ErrorQueue\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p><strong>Note:</strong> Make sure that you update the <a href=\"https://www.nuget.org/packages/Microsoft.Azure.ServiceBus\">Microsoft.Azure.ServiceBus NuGet</a> package to 5.0.0 or above or you might see an error like this when sending messages from the API:</p>\n<p><code>Rebus.Exceptions.RebusApplicationException: Could not send to queue 'MainQueue' ---&gt; System.InvalidOperationException: Operation is not valid due to the current state of the object.</code></p>\n<p>So, we can now run locally just the same as we before, but our messages will be stored in Azure Service Bus and sagas in SQL Azure (don't forget to allow access to SQL Azure from your local IP address!).  Run just the API and post to our <code>/newcustomer</code> route and you will see there is a message in Azure Service Bus:</p>\n<p><img src=\"azure-service-bus-message-peek.png\" alt=\"\"></p>\n<p>Run the back end project and you will see in the console that Rebus has created tables and queues for us before processing the waiting message:</p>\n<p><img src=\"rebus-console-azure-backend-first-run.png\" alt=\"\"></p>\n<p>We now just need to publish our two projects and we'll have our onboarding process running in Azure.  Before you do that, you will need to set up your connection strings in your App Service:</p>\n<p><img src=\"azure-app-service-configuration.png\" alt=\"\"></p>\n<p>To publish our backend processor as a Web Job we'll use Visual Studio (as Rider's Azure integration doesn't include Web Job support - but, hey, who knows what we might get for Xmas! :) ).  The process is pretty simple and you can create your App Services along the way if you want:</p>\n<p><img src=\"visual-studio-publish.png\" alt=\"\"></p>\n<p><strong>Tip:</strong> Make sure you set your Web Job to be continuous when you publish:</p>\n<p><img src=\"visual-studio-publish-ensure-continuous.png\" alt=\"\"></p>\n<p>After you've published, check that your back end is working by looking in the Web Job section:</p>\n<p><img src=\"azure-app-service-web-job-running.png\" alt=\"\"></p>\n<p>If it's not running, click on logs to the output and diagnose.  Once it is running then you should be able to post to the <code>/newcustomer</code> API and see the same output we saw in our console in the Web Job logs:</p>\n<p><img src=\"azure-web-job-log-processed.png\" alt=\"\"></p>\n<p>Congratulations - you now have your onboarding business process running in an Azure App Service Web Job and your API entry point running in Azure App Service.</p>\n<p>The code at this point is in the branch <code>8-running-in-azure</code>.</p>\n<p>Enjoy Rebus!</p>\n",
      "date_published": "2020-12-07T00:00:00Z"
    },{
      "id": "https://seankearon.me/posts/2020/11/using-powershell-to-set-sql-azure-firewall/",
      "url": "https://seankearon.me/posts/2020/11/using-powershell-to-set-sql-azure-firewall/",
      "title": "Use PowerShell to create a SQL Azure firewall rule for your current IP",
      "content_html": "<p>I often connect to my test SQL Azure database instance from my development machine.  To allow connections to the SQL Azure database there must be a rule for your IP address to allow the connection in the SQL Azure database's firewall.  When your IP changes you get an error saying that the connection could not be established.</p>\n<p>You can always use the <a href=\"https://docs.microsoft.com/en-us/azure/azure-sql/database/firewall-create-server-level-portal-quickstart\">Azure Portal</a> to easily add a client IP rule at any time.</p>\n<p><img src=\"azure-portal-firewall-rules.png\" alt=\"&quot;Azure portal firewall rules&quot;\"></p>\n<p>But I find it faster and less distracting to add the firewall client IP rule by running a PowerShell script on my local machine (which I set up behind some keyboard shortcuts).  Here's how...</p>\n<p>Before we can run the script, we need to install the <code>Az</code> and <code>Az.Sql</code> modules, like so:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Install-Module</span> <span class=\"token operator\">-</span>Name Az <span class=\"token operator\">-</span>AllowClobber <span class=\"token operator\">-</span>Scope CurrentUser\n<span class=\"token function\">Install-Module</span> <span class=\"token operator\">-</span>Name Az<span class=\"token punctuation\">.</span>Sql <span class=\"token operator\">-</span>AllowClobber <span class=\"token operator\">-</span>Scope CurrentUser</code></pre>\n<p>We then need to connect to your Azure account, which is done without any pain by running this and following the prompts to log into your Azure account and authenticate your local PowerShell to connect.</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Connect-AzAccount</span></code></pre>\n<p>After you're set up, the script first creates a rule name based on your local username and computer name.  For me, this will be <code>sean-on-SEAN-XPS</code>:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$ruleName</span> = <span class=\"token string\">\"<span class=\"token variable\">$env</span>:USERNAME-on-<span class=\"token variable\">$env</span>:COMPUTERNAME\"</span></code></pre>\n<p>Then we find our current IP address using the wonderful <a href=\"http://checkip.dyndns.org/\">http://checkip.dyndns.org/</a>, which will give us a string something like:  <code>Current IP Address: 111.222.33.444</code>.  We just split that to get the IP address:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$client</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Net<span class=\"token punctuation\">.</span>WebClient\n<span class=\"token namespace\">[xml]</span><span class=\"token variable\">$response</span> = <span class=\"token variable\">$client</span><span class=\"token punctuation\">.</span>DownloadString<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://checkip.dyndns.org\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$ip</span> = <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>body <span class=\"token operator\">-</span>split <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>There is a function called <code>Set-ServerAccess</code> that does the real work, calling into the <code>Az.Sql</code> module we loaded earlier and we remove any existing rules before adding a new one:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">function</span> <span class=\"token function\">Set-ServerAccess</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$subscription</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$resourceGroup</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token variable\">$context</span> = <span class=\"token function\">Get-AzSubscription</span> <span class=\"token operator\">-</span>SubscriptionName <span class=\"token variable\">$subscription</span>\n    <span class=\"token function\">Set-AzContext</span> <span class=\"token variable\">$context</span>\n\n    <span class=\"token function\">Remove-AzSqlServerFirewallRule</span> <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>ErrorAction SilentlyContinue\n    <span class=\"token function\">New-AzSqlServerFirewallRule</span>    <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>StartIpAddress <span class=\"token variable\">$ip</span> <span class=\"token operator\">-</span>EndIpAddress <span class=\"token variable\">$ip</span>\n<span class=\"token punctuation\">}</span></code></pre>\n<p>Then, we just call this for the server you want to connect to.  Just add more lines like this to connect to more than one server:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set-ServerAccess</span> <span class=\"token string\">'your subscription name'</span> <span class=\"token string\">'your resource group'</span> <span class=\"token string\">'your sql azure server name'</span></code></pre>\n<p>That's it, we're connected and back working again!  The full script is available from <a href=\"https://gist.github.com/seankearon/b49ed2aee7363917a61f99689abccbdb\">this Gist</a> and looks like this:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$ruleName</span> = <span class=\"token string\">\"<span class=\"token variable\">$env</span>:USERNAME-on-<span class=\"token variable\">$env</span>:COMPUTERNAME\"</span>\n\n<span class=\"token variable\">$client</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Net<span class=\"token punctuation\">.</span>WebClient\n<span class=\"token namespace\">[xml]</span><span class=\"token variable\">$response</span> = <span class=\"token variable\">$client</span><span class=\"token punctuation\">.</span>DownloadString<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://checkip.dyndns.org\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token variable\">$ip</span> = <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>body <span class=\"token operator\">-</span>split <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Set-ServerAccess</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$subscription</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$resourceGroup</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"Setting access rule for server <span class=\"token variable\">$server</span> in subscription <span class=\"token variable\">$subscription</span>\"</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Write-Host</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span>\n\n    <span class=\"token variable\">$context</span> = <span class=\"token function\">Get-AzSubscription</span> <span class=\"token operator\">-</span>SubscriptionName <span class=\"token variable\">$subscription</span>\n    <span class=\"token function\">Set-AzContext</span> <span class=\"token variable\">$context</span>\n\n    <span class=\"token function\">Remove-AzSqlServerFirewallRule</span> <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>ErrorAction SilentlyContinue\n    <span class=\"token function\">New-AzSqlServerFirewallRule</span>    <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>StartIpAddress <span class=\"token variable\">$ip</span> <span class=\"token operator\">-</span>EndIpAddress <span class=\"token variable\">$ip</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">Set-ServerAccess</span> <span class=\"token string\">'your subscription name'</span> <span class=\"token string\">'your resource group'</span> <span class=\"token string\">'your sql azure server name'</span></code></pre>\n<p>Enjoy!</p>\n",
      "date_published": "2020-11-20T00:00:00Z"
    }
  ]
}
