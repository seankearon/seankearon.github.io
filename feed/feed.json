{
  "version": "https://jsonfeed.org/version/1",
  "title": "Atlantic Breeze",
  "home_page_url": "https://example.com/",
  "feed_url": "https://example.com/feed/feed.json",
  "description": "The technical blog of Sean Kearon",
  "author": {
    "name": "Your Name Here",
    "url": "https://example.com/about-me/"
  },
  "items": [{
      "id": "https://example.com/posts/2020/11/using-powershell-to-set-sql-azure-firewall/",
      "url": "https://example.com/posts/2020/11/using-powershell-to-set-sql-azure-firewall/",
      "title": "Use PowerShell to create a SQL Azure firewall for your current IP",
      "content_html": "<p>I often connect to my test SQL Azure database instance from my development machine.  To allow connect to the SQL Azure database there must be a rule for your IP address to allow the connection in the SQL Azure database's firewall.  When your IP changes you get an error saying that the connection could not be established.</p>\n<p>You can always use use the <a href=\"https://docs.microsoft.com/en-us/azure/azure-sql/database/firewall-create-server-level-portal-quickstart\">Azure Portal</a> to easily add a client IP rule at any time.</p>\n<p><img src=\"azure-portal-firewall-rules.png\" alt=\"&quot;Azure portal firewall rules&quot;\"></p>\n<p>But I find it faster and less distracting to add the firewall client IP rule by running a PowerShell script on my local machine (which I set up behind some keyboard shortcuts).  Here's how...</p>\n<p>Before we can run the script, we need to install the <code>Az</code> and <code>Az.Sql</code> modules, like so:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Install-Module</span> <span class=\"token operator\">-</span>Name Az <span class=\"token operator\">-</span>AllowClobber <span class=\"token operator\">-</span>Scope CurrentUser<br><span class=\"token function\">Install-Module</span> <span class=\"token operator\">-</span>Name Az<span class=\"token punctuation\">.</span>Sql <span class=\"token operator\">-</span>AllowClobber <span class=\"token operator\">-</span>Scope CurrentUser</code></pre>\n<p>We then need to connect to your Azure account, which is done without any pain by running this and following the prompts to log into your Azure account and authenticate your local PowerShell to connect.</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Connect-AzAccount</span></code></pre>\n<p>After you're set up, the script first creates a rule name based on your local username and computer name.  For me, this will be <code>sean-on-SEAN-XPS</code>:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$ruleName</span> = <span class=\"token string\">\"<span class=\"token variable\">$env</span>:USERNAME-on-<span class=\"token variable\">$env</span>:COMPUTERNAME\"</span></code></pre>\n<p>Then we find our current IP address using the wonderful <a href=\"http://checkip.dyndns.org/\">http://checkip.dyndns.org/</a>, which will give us a string something like:  <code>Current IP Address: 111.222.33.444</code>.  We just split that to get the IP address:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$client</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Net<span class=\"token punctuation\">.</span>WebClient<br><span class=\"token namespace\">[xml]</span><span class=\"token variable\">$response</span> = <span class=\"token variable\">$client</span><span class=\"token punctuation\">.</span>DownloadString<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://checkip.dyndns.org\"</span><span class=\"token punctuation\">)</span><br><span class=\"token variable\">$ip</span> = <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>body <span class=\"token operator\">-</span>split <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre>\n<p>There is a function called <code>Set-ServerAccess</code> that does the real work, calling into the <code>Az.Sql</code> module we loaded earlier and we remove any existing rules before adding a new one:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token keyword\">function</span> <span class=\"token function\">Set-ServerAccess</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$subscription</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$resourceGroup</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token variable\">$context</span> = <span class=\"token function\">Get-AzSubscription</span> <span class=\"token operator\">-</span>SubscriptionName <span class=\"token variable\">$subscription</span><br>    <span class=\"token function\">Set-AzContext</span> <span class=\"token variable\">$context</span><br><br>    <span class=\"token function\">Remove-AzSqlServerFirewallRule</span> <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>ErrorAction SilentlyContinue<br>    <span class=\"token function\">New-AzSqlServerFirewallRule</span>    <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>StartIpAddress <span class=\"token variable\">$ip</span> <span class=\"token operator\">-</span>EndIpAddress <span class=\"token variable\">$ip</span><br><span class=\"token punctuation\">}</span></code></pre>\n<p>Then, we just call this for the server you want to connect to.  Just add more lines like this to connect to more than one server:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token function\">Set-ServerAccess</span> <span class=\"token string\">'your subscription name'</span> <span class=\"token string\">'your resource group'</span> <span class=\"token string\">'your sql azure server name'</span></code></pre>\n<p>That's it, we're connected and back working again!  The full script is available from <a href=\"https://gist.github.com/seankearon/b49ed2aee7363917a61f99689abccbdb\">this Gist</a> and looks like this:</p>\n<pre class=\"language-powershell\"><code class=\"language-powershell\"><span class=\"token variable\">$ruleName</span> = <span class=\"token string\">\"<span class=\"token variable\">$env</span>:USERNAME-on-<span class=\"token variable\">$env</span>:COMPUTERNAME\"</span><br><br><span class=\"token variable\">$client</span> = <span class=\"token function\">New-Object</span> System<span class=\"token punctuation\">.</span>Net<span class=\"token punctuation\">.</span>WebClient<br><span class=\"token namespace\">[xml]</span><span class=\"token variable\">$response</span> = <span class=\"token variable\">$client</span><span class=\"token punctuation\">.</span>DownloadString<span class=\"token punctuation\">(</span><span class=\"token string\">\"http://checkip.dyndns.org\"</span><span class=\"token punctuation\">)</span><br><span class=\"token variable\">$ip</span> = <span class=\"token punctuation\">(</span><span class=\"token variable\">$response</span><span class=\"token punctuation\">.</span>html<span class=\"token punctuation\">.</span>body <span class=\"token operator\">-</span>split <span class=\"token string\">':'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span>1<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>Trim<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><br><br><span class=\"token keyword\">function</span> <span class=\"token function\">Set-ServerAccess</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$subscription</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$resourceGroup</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$server</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><br>    <span class=\"token string\">\"Setting access rule for server <span class=\"token variable\">$server</span> in subscription <span class=\"token variable\">$subscription</span>\"</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Write-Host</span> <span class=\"token punctuation\">|</span> <span class=\"token function\">Out-Null</span><br><br>    <span class=\"token variable\">$context</span> = <span class=\"token function\">Get-AzSubscription</span> <span class=\"token operator\">-</span>SubscriptionName <span class=\"token variable\">$subscription</span><br>    <span class=\"token function\">Set-AzContext</span> <span class=\"token variable\">$context</span><br><br>    <span class=\"token function\">Remove-AzSqlServerFirewallRule</span> <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>ErrorAction SilentlyContinue<br>    <span class=\"token function\">New-AzSqlServerFirewallRule</span>    <span class=\"token operator\">-</span>ServerName <span class=\"token variable\">$server</span> <span class=\"token operator\">-</span>ResourceGroupName <span class=\"token variable\">$resourceGroup</span> <span class=\"token operator\">-</span>FirewallRuleName <span class=\"token variable\">$ruleName</span> <span class=\"token operator\">-</span>StartIpAddress <span class=\"token variable\">$ip</span> <span class=\"token operator\">-</span>EndIpAddress <span class=\"token variable\">$ip</span><br><span class=\"token punctuation\">}</span><br><br><span class=\"token function\">Set-ServerAccess</span> <span class=\"token string\">'your subscription name'</span> <span class=\"token string\">'your resource group'</span> <span class=\"token string\">'your sql azure server name'</span></code></pre>\n<p>Enjoy!</p>\n",
      "date_published": "2020-11-20T00:00:00+00:00"
    }
  ]
}
